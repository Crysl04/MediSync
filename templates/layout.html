<!DOCTYPE html>
<html lang="en">
<head>
  <title>{% block title %}MediSync{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=analytics" />

  <style>
    /* Dashboard-style notification popup */
    .notification-popup {
      position: fixed !important; 
      bottom: 16px !important;
      right: 16px !important;
      top: auto !important;
      left: auto !important;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 10 12px;
      width: 240px;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0px 3px 8px rgba(0,0,0,0.15);
      z-index: 9999;
    }
    .notification-popup.hidden { display: none; }
    .notification-buttons { display: flex; justify-content: space-between; margin-top: 10px; }
    .notif-close { cursor: pointer; font-size: 18px; }

    /* Centered Alert Modal - REPOSITIONED TO BOTTOM RIGHT */
    .notification-modal {
      position: fixed;
      bottom: 20px;  /* Changed from top: 20px */
      right: 20px;
      top: auto;     /* Added to override any top positioning */
      z-index: 9999;
      padding: 0;
      pointer-events: none;
      opacity: 0;
      transform: translateY(20px); /* Changed from translateY(-10px) to slide up */
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .notification-modal.show {
      pointer-events: auto;
      opacity: 1;
      transform: translateY(0);
    }

    /* Modal Box */
    .modal-content {
      background: #d9e9f6;
      width: 340px;
      padding: 25px;
      border-radius: 15px;
      position: relative;
      text-align: center;
      box-shadow: 0px 6px 12px rgba(0,0,0,0.15);
    }

    /* Close (X) */
    .modal-close {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 20px;
      cursor: pointer;
      color: #042f50;
    }

    /* Red Warning Icon */
    .alert-icon {
      font-size: 55px;
      color: #e62e2e;
      margin-bottom: 10px;
    }

    /* Title */
    .alert-title {
      font-size: 20px;
      font-weight: bold;
      color: #042f50;
      margin-bottom: 8px;
    }

    /* Description text */
    .alert-text {
      color: #042f50;
      font-size: 15px;
      margin-bottom: 20px;
    }

    /* Buttons */
    .modal-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .btn-filled {
      background: #042f50;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid #042f50;
      color: #042f50;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
    }

    /* User Alert Modal (for success/error messages) - REPOSITIONED TO BOTTOM RIGHT */
    .user-alert-modal {
      position: fixed;
      bottom: 20px;  /* Changed from top: 20px */
      right: 20px;
      top: auto;     /* Added to override any top positioning */
      z-index: 10000;
      background: white;
      width: 320px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 20px;
      display: none;
      align-items: center;
      gap: 15px;
      border-left: 5px solid #3498db;
      animation: slideInFromBottom 0.3s ease; /* Changed animation */
    }

    .user-alert-modal.show {
      display: flex;
    }

    .user-alert-modal.success {
      border-left-color: #2ecc71;
      background: #f0fdf4;
    }

    .user-alert-modal.error {
      border-left-color: #e74c3c;
      background: #fef2f2;
    }

    .user-alert-modal.warning {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }

    .user-alert-modal.info {
      border-left-color: #3498db;
      background: #eff6ff;
    }

    .user-alert-icon {
      font-size: 24px;
      min-width: 24px;
    }

    .success .user-alert-icon { color: #2ecc71; }
    .error .user-alert-icon { color: #e74c3c; }
    .warning .user-alert-icon { color: #f59e0b; }
    .info .user-alert-icon { color: #3498db; }

    .user-alert-content {
      flex: 1;
    }

    .user-alert-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #1f2937;
    }

    .user-alert-message {
      color: #6b7280;
      font-size: 14px;
    }

    .user-alert-close {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-alert-close:hover {
      color: #374151;
    }

    /* Updated animation for bottom-right positioning */
    @keyframes slideInFromBottom {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Optional: Add a container for stacking notifications if needed */
    .notification-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      z-index: 9998;
    }
  </style>
  
</head>

<body class="dashboard-body">
  <aside>
    <div>
      <div class="logo">MediSync</div>
      <nav>
        <a href="{{ url_for('dashboard') }}"><i class="fa-solid fa-chart-line"></i>Dashboard</a>
        <a href="{{ url_for('notification') }}"><i class="fa-solid fa-bell"></i>Notifications</a>
        <a href="{{ url_for('products') }}"><i class="fa-solid fa-pills"></i>Products</a>
        <a href="{{ url_for('purchases') }}"><i class="fa-solid fa-solid fa-cart-shopping"></i>Stock in</a>
        <a href="{{ url_for('orders') }}"><i class="fa-solid fa-truck"></i>Stock out</a>
      </nav>
    </div>
    <a href="/logout" class="logout">Log Out</a>
  </aside>

  <main class="main">
    {% block content %}{% endblock %}
  </main>

  <!-- 1. User Alert Modal (for success/error messages - replaces alert()) -->
  <div id="user-alert-popup" class="user-alert-modal">
    <div class="user-alert-icon">
      <i id="user-alert-icon" class="fa-solid"></i>
    </div>
    <div class="user-alert-content">
      <div id="user-alert-title" class="user-alert-title"></div>
      <div id="user-alert-message" class="user-alert-message"></div>
    </div>
    <button id="user-alert-close-btn" class="user-alert-close">
      <i class="fa-solid fa-times"></i>
    </button>
  </div>

  <!-- 2. Existing Notification Modal (for automated alerts) -->
  <div id="notification-popup" class="notification-modal hidden">
    <div class="modal-content">
      <span id="close-notif-btn" class="modal-close">&times;</span>

      <div class="alert-icon">
        <i class="fa-solid fa-circle-exclamation"></i>
      </div>

      <h2 id="notification-title" class="alert-title"></h2>
      <p id="notification-message" class="alert-text"></p>

      <div class="modal-buttons">
        <button id="ignore-notif-btn" class="btn-outline">Ignore Notification</button>
        <button id="notify-again-btn" class="btn-filled">Notify Me Again</button>
      </div>
    </div>
  </div>

  <!-- EXISTING NOTIFICATION SYSTEM JS - UPDATED -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('notification-popup');
    const messageEl = document.getElementById('notification-message');
    const closeBtn = document.getElementById('close-notif-btn');
    const notifyAgainBtn = document.getElementById('notify-again-btn');
    const ignoreBtn = document.getElementById('ignore-notif-btn');

    let queue = [];
    let showing = false;
    let current = null;

    function show(notif) {
        if (showing) return;

        current = notif;
        showing = true;

        // Remove hidden class to ensure it's visible
        popup.classList.remove('hidden');
        
        messageEl.textContent = notif.message;
        document.getElementById('notification-title').textContent = getAlertTitle(notif.type);
        
        // Use setTimeout to ensure the display is set before adding show class
        setTimeout(() => {
            popup.classList.add('show');
        }, 10);

        // mark as "last shown" for interval check
        localStorage.setItem(`notif_${notif.id}`, Date.now());

        // update server last_notified timestamp
        fetch(`/touch-notification/${notif.id}`, { method: 'POST' });
    }

    function hide() {
        // Remove the show class to trigger the fade-out animation
        popup.classList.remove('show');
        showing = false;
        current = null;

        // Wait for the fade-out animation to complete, then add hidden class
        setTimeout(() => {
            popup.classList.add('hidden');
            showNext();
        }, 400); // Match this with your CSS transition duration (0.4s)
    }

    function showNext() {
        if (showing || queue.length === 0) return;
        show(queue.shift());
    }

    async function fetchNotifications() {
        const INTERVAL = 30 * 1000; // 30 seconds
        const res = await fetch('{{ url_for("notification_json") }}');
        const data = await res.json();

        queue = data.filter(n => {
            if (n.ignored) return false;

            const lastShown = localStorage.getItem(`notif_${n.id}`);
            return !lastShown || (Date.now() - lastShown) >= INTERVAL;
        });

        showNext();
    }

    function getAlertTitle(type) {
        switch (type) {
            case 'low-stock':
                return 'Low Stock Alert!';
            case 'out-of-stock':
                return 'Out of Stock Alert!';
            case 'near-expiry':
                return 'Near Expiry Alert!';
            case 'expired':
                return 'Expired Product Alert!';
            default:
                return 'Notification';
        }
    }

    async function markAsRead(id) {
        await fetch(`/read-notification/${id}`, { method: 'POST' });
    }

    // Add visual feedback for button clicks
    function addButtonFeedback(button) {
        button.classList.add('clicked');
        setTimeout(() => {
            button.classList.remove('clicked');
        }, 200);
    }

    closeBtn.onclick = () => {
        addButtonFeedback(closeBtn);
        if (current) markAsRead(current.id);
        hide();
    };

    notifyAgainBtn.onclick = () => {
        addButtonFeedback(notifyAgainBtn);
        if (current) markAsRead(current.id);
        hide();
    };

    ignoreBtn.onclick = async () => {
        // Add visual feedback
        addButtonFeedback(ignoreBtn);
        
        if (!current) return;

        // Optional: Show a brief loading state on the button
        const originalText = ignoreBtn.textContent;
        ignoreBtn.textContent = 'Ignoring...';
        ignoreBtn.disabled = true;

        try {
            await fetch(`/ignore-notification/${current.id}`, { method: 'POST' });
            await markAsRead(current.id);
            
            // Show success feedback
            ignoreBtn.textContent = 'Ignored!';
            setTimeout(() => {
                hide();
            }, 500);
        } catch (error) {
            // Reset button if error
            ignoreBtn.textContent = originalText;
            ignoreBtn.disabled = false;
            console.error('Error ignoring notification:', error);
        }
    };

    fetchNotifications();
    setInterval(fetchNotifications, 30000);
});
</script>


