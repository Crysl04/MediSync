{% extends 'layout.html' %}
{% block title %}MediSync - Orders{% endblock %}

{% block content %}
<div class="main">
  <header class="dashboard-header">
    <h1>Inventory Management</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="static/profile.png" alt="Profile Picture" width="40" height="40" style="border-radius: 50%;"> 
      <div>
        <strong>{{ session['name'] }}</strong><br>
        <small>Administrator</small>
      </div>
    </div>
  </header>

  <hr class="hr-line">

  <div class="products-controls">
    <div class="filter-btn">
      <input type="text" id="searchOrders" placeholder="Search orders..." onkeyup="applyOrderFilters()" />
      <button onclick="toggleOrderFilterOptions()">
        <img src="{{ url_for('static', filename='filter.png') }}" alt="Filter Icon" class="filter-icon">
        FILTER
      </button>
      <div id="orderFilterOptions" class="filter-options" style="display: none;">
        <div class="filter-group">
          <!-- Change "Batch Number" to "Invoice Number" -->
          <label>Invoice Number:</label>
          <input type="text" id="invoiceFilter" placeholder="Enter invoice number..." onkeyup="applyOrderFilters()" />
        </div>
        <div class="filter-group">
          <label>Order Date:</label>
          <input type="date" id="dateFilter" onchange="applyOrderFilters()" />
        </div>
      </div>
    </div>
    <button class="add-btn" onclick="openAddOrderModal()">+ Add Order</button>
  </div>

  <div class="orders-table">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Invoice Number</th>
          <th>Delivery Date</th>
          <th>Customer</th>
          <th>Product Name</th>
          <th>Dosage</th>
          <th>Quantity</th>
          <th>Unit</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if orders %}
          {% for order in orders %}
            <tr data-order-id="{{ order[0] }}" 
                data-invoice="{{ order[6] }}"
                data-quantity="{{ order[2] }}" 
                data-date="{{ order[4] }}" 
                data-customer="{{ order[5] }}">
              <td>{{ order[6] if order[6] else 'N/A' }}</td> <!-- Invoice Number -->
              <td>{{ order[4] }}</td> <!-- Order Date -->
              <td>{{ order[5] }}</td> <!-- Customer -->
              <td>{{ order[1] }}</td> <!-- Product Name -->
              <td>{{ order[8] if order[8] else '' }}</td> <!-- Dosage -->
              <td>{{ order[2] }}</td> <!-- Quantity -->
              <td>{{ order[7] if order[7] else 'N/A' }}</td> <!-- Unit -->
              <td>
                <button onclick="openEditOrderModal('{{ order[0] }}', '{{ order[1] }}', '{{ order[6] }}', '{{ order[2] }}', '{{ order[5] }}', '{{ order[8] }}', '{{ order[7] }}')">Edit</button>
                <button onclick="deleteOrder('{{ order[0] }}')">Delete</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" style="text-align: center;">No orders found</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  td button {
    margin: 2px;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  td button:first-child {
    background-color: #4CAF50;
    color: white;
  }
  td button:last-child {
    background-color: #f44336;
    color: white;
  }
  /* Style for datalist dropdown */
  datalist {
    max-height: 200px;
    overflow-y: auto;
  }
</style>

<!-- Invoice Number Datalist (for both modals) -->
<datalist id="invoiceNumbersList">
  {% for inv in invoice_data %}
    <option value="{{ inv[0] }}" 
            data-product="{{ inv[1] }}" 
            data-dosage="{{ inv[2] if inv[2] else '' }}" 
            data-unit="{{ inv[3] if inv[3] else '' }}">
      {{ inv[0] }} - {{ inv[1] }}{% if inv[2] %} ({{ inv[2] }}){% endif %}
    </option>
  {% endfor %}
</datalist>

<!-- Add Order Modal -->
<div id="addOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:350px; position:relative;">
    <h2>Add Order</h2>
    <form id="addOrderForm" method="POST">
      <label>Invoice Number:</label><br>
      <!-- Changed from select to input with datalist -->
      <input type="text" name="invoice_number" id="addInvoiceNumber" 
             list="invoiceNumbersList" 
             placeholder="Type to search invoice numbers..." 
             autocomplete="off"
             required 
             oninput="updateProductInfo()">
      <br><br>

      <label>Product:</label><br>
      <input type="text" id="addProductInfo" readonly><br><br>

      <label>Available Quantity:</label><br>
      <input type="text" id="addAvailableQty" readonly><br><br>

      <label>Order Quantity:</label><br>
      <input type="number" name="order_quantity" id="addOrderQuantity" min="1" required><br><br>

      <label>Customer:</label><br>
      <select name="customer" id="addCustomer" onchange="toggleOtherCustomer('add')" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer }}">{{ customer }}</option>
        {% endfor %}
        <option value="__other__">Other (enter below)</option>
      </select>
      <div id="addOtherCustomerGroup" style="display:none; margin-top:5px;">
        <input type="text" id="addOtherCustomerInput" placeholder="Enter customer name">
      </div>
      <br><br>

      <div style="text-align:right;">
        <button type="button" onclick="closeAddOrderModal()">Cancel</button>
        <button type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Order Modal -->
<div id="editOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:350px; position:relative;">
    <h2>Edit Order</h2>
    <form id="editOrderForm" method="POST">
      <input type="hidden" name="order_id" id="editOrderId">

      <label>Invoice Number:</label><br>
      <!-- Changed from select to input with datalist -->
      <input type="text" name="invoice_number" id="editInvoiceNumber" 
             list="invoiceNumbersList" 
             placeholder="Type to search invoice numbers..." 
             autocomplete="off"
             required 
             oninput="updateEditProductInfo()">
      <br><br>

      <label>Product:</label><br>
      <input type="text" id="editProductInfo" readonly><br><br>

      <label>Available Quantity:</label><br>
      <input type="text" id="editAvailableQty" readonly><br><br>

      <label>Order Quantity:</label><br>
      <input type="number" name="order_quantity" id="editOrderQuantity" min="1" required><br><br>

      <label>Customer:</label><br>
      <select name="customer" id="editCustomer" onchange="toggleOtherCustomer('edit')" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer }}">{{ customer }}</option>
        {% endfor %}
        <option value="__other__">Other (enter below)</option>
      </select>
      <div id="editOtherCustomerGroup" style="display:none; margin-top:5px;">
        <input type="text" id="editOtherCustomerInput" placeholder="Enter customer name">
      </div>
      <br><br>

      <div style="text-align:right;">
        <button type="button" onclick="closeEditOrderModal()">Cancel</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
// Create a map to store invoice data for quick lookup
let invoiceDataMap = {};

// Debounce function to limit how often a function is called
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Initialize the invoice data map when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Get all options from the datalist
  const datalist = document.getElementById('invoiceNumbersList');
  const options = datalist ? datalist.querySelectorAll('option') : [];
  
  // Populate the invoice data map
  options.forEach(option => {
    invoiceDataMap[option.value] = {
      product: option.getAttribute('data-product'),
      dosage: option.getAttribute('data-dosage'),
      unit: option.getAttribute('data-unit')
    };
  });
  
  console.log('Invoice data map loaded:', invoiceDataMap);
});

// Filter functions
function toggleOrderFilterOptions() {
  const filterBox = document.getElementById("orderFilterOptions");
  filterBox.style.display = filterBox.style.display === "none" ? "block" : "none";
}

function applyOrderFilters() {
  const searchValue = document.getElementById("searchOrders").value.toLowerCase();
  const invoiceValue = document.getElementById("invoiceFilter").value.toLowerCase();
  const dateValue = document.getElementById("dateFilter").value;

  const rows = document.querySelectorAll("#ordersTable tbody tr");
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    const rowInvoice = row.getAttribute("data-invoice")?.toLowerCase() || '';
    const rowDate = row.getAttribute("data-date");

    const matchesSearch = text.includes(searchValue);
    const matchesInvoice = !invoiceValue || rowInvoice.includes(invoiceValue);
    const matchesDate = !dateValue || rowDate === dateValue;

    row.style.display = matchesSearch && matchesInvoice && matchesDate ? "" : "none";
  });
}

// Add Order Modal functions
function openAddOrderModal() { 
  console.log("openAddOrderModal called");
  document.getElementById('addOrderModal').style.display = 'block';
  // Reset form
  document.getElementById('addOrderForm').reset();
  // Clear product info fields
  document.getElementById('addProductInfo').value = '';
  document.getElementById('addAvailableQty').value = '';
  document.getElementById('addOrderQuantity').value = '';
  document.getElementById('addCustomer').selectedIndex = 0;
  document.getElementById('addOtherCustomerGroup').style.display = 'none';
}

function closeAddOrderModal() { 
  document.getElementById('addOrderModal').style.display = 'none';
  document.getElementById('addOrderForm').reset();
}

// Edit Order Modal functions
function openEditOrderModal(orderId, productName, invoiceNumber, quantity, customer, dosage, unit) {
  console.log("openEditOrderModal called with:", {orderId, productName, invoiceNumber, quantity, customer, dosage, unit});
  
  document.getElementById('editOrderId').value = orderId;
  const editInvoiceInput = document.getElementById('editInvoiceNumber');
  editInvoiceInput.value = invoiceNumber;
  
  // Store old values for calculation
  editInvoiceInput.setAttribute('data-old-invoice', invoiceNumber);
  editInvoiceInput.setAttribute('data-old-quantity', quantity);
  
  document.getElementById('editOrderQuantity').value = quantity;
  document.getElementById('editProductInfo').value = productName;
  
  // Set customer dropdown
  const customerSelect = document.getElementById('editCustomer');
  const otherGroup = document.getElementById('editOtherCustomerGroup');
  const otherInput = document.getElementById('editOtherCustomerInput');
  
  // Try to find the customer in the options
  let found = false;
  for (let option of customerSelect.options) {
    if (option.textContent === customer) {
      customerSelect.value = option.value;
      found = true;
      otherGroup.style.display = 'none';
      break;
    }
  }
  
  // If customer not found in the list, show "Other" input
  if (!found) {
    customerSelect.value = '__other__';
    otherGroup.style.display = 'block';
    otherInput.value = customer;
  }
  
  // Fetch available quantity for the selected invoice
  updateEditProductInfo();
  
  document.getElementById('editOrderModal').style.display = 'block';
}
  
function closeEditOrderModal() { 
  document.getElementById('editOrderModal').style.display = 'none';
}

// Toggle other customer input
function toggleOtherCustomer(type) {
  const customerSelect = document.getElementById(type === 'add' ? 'addCustomer' : 'editCustomer');
  const otherGroup = document.getElementById(type === 'add' ? 'addOtherCustomerGroup' : 'editOtherCustomerGroup');
  
  if (customerSelect.value === '__other__') {
    otherGroup.style.display = 'block';
  } else {
    otherGroup.style.display = 'none';
  }
}

// Update product info when invoice is selected (for add order) - DEBOUNCED
const debouncedUpdateProductInfo = debounce(function() {
  const invoiceInput = document.getElementById('addInvoiceNumber');
  const invoiceNumber = invoiceInput.value.trim();
  
  if (!invoiceNumber) {
    document.getElementById('addProductInfo').value = '';
    document.getElementById('addAvailableQty').value = '';
    return;
  }
  
  // Check if the invoice number exists in our map for instant feedback
  if (invoiceDataMap[invoiceNumber]) {
    const invoiceData = invoiceDataMap[invoiceNumber];
    document.getElementById('addProductInfo').value = invoiceData.product || '';
  } else {
    // If not found in map, clear the field (we'll validate on submit)
    document.getElementById('addProductInfo').value = '';
  }
  
  // Fetch available quantity from server - only if invoice is at least 3 characters
  if (invoiceNumber.length >= 3) {
    fetch(`/get-purchase-info/${invoiceNumber}`)
      .then(res => {
        if (!res.ok) {
          throw new Error('Network response was not ok');
        }
        return res.json();
      })
      .then(data => {
        if (data.success) {
          document.getElementById('addAvailableQty').value = data.remaining_quantity;
          document.getElementById('addProductInfo').value = data.product_name || '';
          // If invoice was valid, remove any error styling
          invoiceInput.style.borderColor = '';
        } else {
          // If invoice not found, clear the fields
          document.getElementById('addProductInfo').value = '';
          document.getElementById('addAvailableQty').value = '';
          // Show a subtle hint that invoice is not valid
          invoiceInput.style.borderColor = data.message ? '#ff4444' : '';
        }
      })
      .catch(err => {
        console.error('Error:', err);
        document.getElementById('addProductInfo').value = '';
        document.getElementById('addAvailableQty').value = '';
      });
  } else {
    // Clear fields if invoice is too short
    document.getElementById('addProductInfo').value = '';
    document.getElementById('addAvailableQty').value = '';
  }
}, 500); // 500ms delay

// Update product info when invoice is selected (for edit order) - DEBOUNCED
const debouncedUpdateEditProductInfo = debounce(function() {
  const invoiceInput = document.getElementById('editInvoiceNumber');
  const invoiceNumber = invoiceInput.value.trim();
  const oldInvoice = invoiceInput.getAttribute('data-old-invoice');
  const oldQuantity = parseInt(invoiceInput.getAttribute('data-old-quantity') || 0);
  
  if (!invoiceNumber) {
    document.getElementById('editProductInfo').value = '';
    document.getElementById('editAvailableQty').value = '';
    return;
  }
  
  // Check if the invoice number exists in our map for instant feedback
  if (invoiceDataMap[invoiceNumber]) {
    const invoiceData = invoiceDataMap[invoiceNumber];
    document.getElementById('editProductInfo').value = invoiceData.product || '';
  } else {
    // If not found in map, clear the field (we'll validate on submit)
    document.getElementById('editProductInfo').value = '';
  }
  
  // Fetch available quantity from server - only if invoice is at least 3 characters
  if (invoiceNumber.length >= 3) {
    fetch(`/get-purchase-info/${invoiceNumber}`)
      .then(res => {
        if (!res.ok) {
          throw new Error('Network response was not ok');
        }
        return res.json();
      })
      .then(data => {
        if (data.success) {
          let available = data.remaining_quantity;
          
          // If editing the same invoice, add back the old order quantity
          // because it will be available for reallocation
          if (invoiceNumber === oldInvoice) {
            available += oldQuantity;
          }
          
          document.getElementById('editAvailableQty').value = available;
          document.getElementById('editProductInfo').value = data.product_name || '';
          // If invoice was valid, remove any error styling
          invoiceInput.style.borderColor = '';
        } else {
          // If invoice not found, clear the fields
          document.getElementById('editProductInfo').value = '';
          document.getElementById('editAvailableQty').value = '';
          // Show a subtle hint that invoice is not valid
          invoiceInput.style.borderColor = data.message ? '#ff4444' : '';
        }
      })
      .catch(err => {
        console.error('Error:', err);
        document.getElementById('editProductInfo').value = '';
        document.getElementById('editAvailableQty').value = '';
      });
  } else {
    // Clear fields if invoice is too short
    document.getElementById('editProductInfo').value = '';
    document.getElementById('editAvailableQty').value = '';
  }
}, 500); // 500ms delay

// Form submission handlers
document.addEventListener('DOMContentLoaded', function() {
  // Get the input elements
  const addInvoiceInput = document.getElementById('addInvoiceNumber');
  const editInvoiceInput = document.getElementById('editInvoiceNumber');
  
  // Set up debounced event listeners
  if (addInvoiceInput) {
    addInvoiceInput.addEventListener('input', debouncedUpdateProductInfo);
  }
  
  if (editInvoiceInput) {
    editInvoiceInput.addEventListener('input', debouncedUpdateEditProductInfo);
  }
  
  // Add Order Form Submission
  const addOrderForm = document.getElementById('addOrderForm');
  if (addOrderForm) {
    addOrderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      let customerValue;
      const customerSelect = document.getElementById('addCustomer');
      
      // If "Other" is selected, use the custom input value
      if (customerSelect.value === '__other__') {
        const otherCustomer = document.getElementById('addOtherCustomerInput').value;
        if (otherCustomer.trim() === '') {
          alert('Please enter a customer name');
          return;
        }
        customerValue = otherCustomer;
      } else {
        customerValue = customerSelect.value;
      }
      
      const invoiceNumber = document.getElementById('addInvoiceNumber').value.trim();
      const quantity = parseInt(document.getElementById('addOrderQuantity').value);

      if(!invoiceNumber || isNaN(quantity) || !customerValue) {
        alert('Please fill all fields correctly.');
        return;
      }
      
      // Validate invoice number exists in our map or in the database
      // We'll let the server validate it to avoid false negatives
      fetch('/add-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          invoice_number: invoiceNumber, 
          order_quantity: quantity, 
          customer: customerValue 
        })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if(data.success) location.reload();
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error: ' + err);
      });
    });
  }

  // Edit Order Form Submission
  const editOrderForm = document.getElementById('editOrderForm');
  if (editOrderForm) {
    editOrderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      let customerValue;
      const customerSelect = document.getElementById('editCustomer');
      
      // If "Other" is selected, use the custom input value
      if (customerSelect.value === '__other__') {
        const otherCustomer = document.getElementById('editOtherCustomerInput').value;
        if (otherCustomer.trim() === '') {
          alert('Please enter a customer name');
          return;
        }
        customerValue = otherCustomer;
      } else {
        customerValue = customerSelect.value;
      }
      
      const orderId = document.getElementById('editOrderId').value;
      const invoiceNumber = document.getElementById('editInvoiceNumber').value.trim();
      const quantity = document.getElementById('editOrderQuantity').value;

      fetch(`/edit-order/${orderId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          invoice_number: invoiceNumber, 
          order_quantity: quantity, 
          customer: customerValue 
        })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if(data.success) location.reload();
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error: ' + err);
      });
    });
  }
  
  // Add event listeners for search and filter
  const searchInput = document.getElementById('searchOrders');
  const invoiceFilter = document.getElementById('invoiceFilter');
  const dateFilter = document.getElementById('dateFilter');
  
  if (searchInput) {
    searchInput.addEventListener('keyup', applyOrderFilters);
  }
  if (invoiceFilter) {
    invoiceFilter.addEventListener('keyup', applyOrderFilters);
  }
  if (dateFilter) {
    dateFilter.addEventListener('change', applyOrderFilters);
  }
  
  // Add keyboard navigation for invoice input
  [addInvoiceInput, editInvoiceInput].forEach(input => {
    if (input) {
      input.addEventListener('keydown', function(e) {
        // If user presses Enter in the invoice field, prevent form submission
        if (e.key === 'Enter') {
          e.preventDefault();
          // Trigger the debounced update function immediately
          if (input.id === 'addInvoiceNumber') {
            debouncedUpdateProductInfo();
          } else {
            debouncedUpdateEditProductInfo();
          }
        }
      });
      
      // Also update on blur (when user clicks away)
      input.addEventListener('blur', function() {
        if (input.id === 'addInvoiceNumber') {
          debouncedUpdateProductInfo();
        } else {
          debouncedUpdateEditProductInfo();
        }
      });
    }
  });
});

// Delete order
function deleteOrder(orderId) {
  if(confirm('Are you sure you want to delete this order?')) {
    fetch(`/delete-order/${orderId}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if(data.success) location.reload();
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error deleting order: ' + err);
      });
  }
}
</script>
{% endblock %}




