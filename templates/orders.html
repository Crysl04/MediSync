{% extends 'layout.html' %}
{% block title %}MediSync - Orders{% endblock %}

{% block content %}
<div class="main">
  <header class="dashboard-header">
    <h1>Inventory Management</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="static/profile.png" alt="Profile Picture" width="40" height="40" style="border-radius: 50%;"> 
      <div>
        <strong>{{ session['name'] }}</strong><br>
        <small>Administrator</small>
      </div>
    </div>
  </header>

  <hr class="hr-line">

  <div class="products-controls">
    <div class="filter-btn">
      <input type="text" id="searchOrders" placeholder="Search orders..." onkeyup="applyOrderFilters()" />
      <button onclick="toggleOrderFilterOptions()">
        <img src="{{ url_for('static', filename='filter.png') }}" alt="Filter Icon" class="filter-icon">
        FILTER
      </button>
      <div id="orderFilterOptions" class="filter-options" style="display: none;">
        <div class="filter-group">
          <!-- Change "Batch Number" to "Invoice Number" -->
          <label>Invoice Number:</label>
          <input type="text" id="invoiceFilter" placeholder="Enter invoice number..." onkeyup="applyOrderFilters()" />
        </div>
        <div class="filter-group">
          <label>Order Date:</label>
          <input type="date" id="dateFilter" onchange="applyOrderFilters()" />
        </div>
      </div>
    </div>
    <button class="add-btn" onclick="openAddOrderModal()">+ Add Order</button>
  </div>

  <div class="orders-table">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Invoice Number</th>
          <th>Delivery Date</th>
          <th>Customer</th>
          <th>Product Name</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if orders %}
          {% for order in orders %}
            <tr data-order-id="{{ order[0] }}" 
                data-invoice="{{ order[6] }}"  <!-- invoice_number -->
                data-quantity="{{ order[2] }}" 
                data-date="{{ order[4] }}" 
                data-customer="{{ order[5] }}">
              <td>{{ order[6] if order[6] else 'N/A' }}</td> <!-- Invoice Number -->
              <td>{{ order[4] }}</td> <!-- Order Date -->
              <td>{{ order[5] }}</td> <!-- Customer -->
              <td>{{ order[1] }}</td> <!-- Product Name -->
              <td>{{ order[2] }}</td> <!-- Quantity -->
              <td>
                <button onclick="openEditOrderModal('{{ order[0] }}', '{{ order[1] }}', '{{ order[6] }}', '{{ order[2] }}', '{{ order[5] }}')">Edit</button>
                <button onclick="deleteOrder('{{ order[0] }}')">Delete</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" style="text-align: center;">No orders found</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  td button {
    margin: 2px;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  td button:first-child {
    background-color: #4CAF50;
    color: white;
  }
  td button:last-child {
    background-color: #f44336;
    color: white;
  }
</style>

<!-- Add Order Modal -->
<div id="addOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:350px; position:relative;">
    <h2>Add Order</h2>
    <form id="addOrderForm" method="POST">
      <label>Invoice Number:</label><br>
      <select name="invoice_number" id="addInvoiceNumber" required onchange="updateProductInfo()">
        <option value="">Select Invoice Number</option>
        {% for inv in invoice_numbers %}
          <option value="{{ inv }}">{{ inv }}</option>
        {% endfor %}
      </select><br><br>

      <label>Product:</label><br>
      <input type="text" id="addProductInfo" readonly><br><br>

      <label>Available Quantity:</label><br>
      <input type="text" id="addAvailableQty" readonly><br><br>

      <label>Order Quantity:</label><br>
      <input type="number" name="order_quantity" id="addOrderQuantity" min="1" required><br><br>

      <label>Customer:</label><br>
      <select name="customer" id="addCustomer" onchange="toggleOtherCustomer('add')" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer }}">{{ customer }}</option>
        {% endfor %}
        <option value="__other__">Other (enter below)</option>
      </select>
      <div id="addOtherCustomerGroup" style="display:none; margin-top:5px;">
        <input type="text" id="addOtherCustomerInput" placeholder="Enter customer name">
      </div>
      <br><br>

      <div style="text-align:right;">
        <button type="button" onclick="closeAddOrderModal()">Cancel</button>
        <button type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Order Modal -->
<div id="editOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:350px; position:relative;">
    <h2>Edit Order</h2>
    <form id="editOrderForm" method="POST">
      <input type="hidden" name="order_id" id="editOrderId">

      <label>Invoice Number:</label><br>
      <select name="invoice_number" id="editInvoiceNumber" required onchange="updateEditProductInfo()">
        <option value="">Select Invoice Number</option>
        {% for inv in invoice_numbers %}
          <option value="{{ inv }}">{{ inv }}</option>
        {% endfor %}
      </select><br><br>

      <label>Product:</label><br>
      <input type="text" id="editProductInfo" readonly><br><br>

      <label>Available Quantity:</label><br>
      <input type="text" id="editAvailableQty" readonly><br><br>

      <label>Order Quantity:</label><br>
      <input type="number" name="order_quantity" id="editOrderQuantity" min="1" required><br><br>

      <label>Customer:</label><br>
      <select name="customer" id="editCustomer" onchange="toggleOtherCustomer('edit')" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer }}">{{ customer }}</option>
        {% endfor %}
        <option value="__other__">Other (enter below)</option>
      </select>
      <div id="editOtherCustomerGroup" style="display:none; margin-top:5px;">
        <input type="text" id="editOtherCustomerInput" placeholder="Enter customer name">
      </div>
      <br><br>

      <div style="text-align:right;">
        <button type="button" onclick="closeEditOrderModal()">Cancel</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
function toggleOrderFilterOptions() {
  const filterBox = document.getElementById("orderFilterOptions");
  filterBox.style.display = filterBox.style.display === "none" ? "block" : "none";
}

function applyOrderFilters() {
  const searchValue = document.getElementById("searchOrders").value.toLowerCase();
  const invoiceValue = document.getElementById("invoiceFilter").value.toLowerCase(); // Changed from batchFilter
  const dateValue = document.getElementById("dateFilter").value;

  const rows = document.querySelectorAll("#ordersTable tbody tr");
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    const rowInvoice = row.getAttribute("data-invoice")?.toLowerCase() || ''; // Changed from data-batch
    const rowDate = row.getAttribute("data-date");

    const matchesSearch = text.includes(searchValue);
    const matchesInvoice = rowInvoice.includes(invoiceValue);
    const matchesDate = dateValue === "" || rowDate === dateValue;

    row.style.display = matchesSearch && matchesInvoice && matchesDate ? "" : "none";
  });
}

// Add Order Modal functions
function openAddOrderModal() { 
  document.getElementById('addOrderModal').style.display = 'block';
  // Reset form
  document.getElementById('addOrderForm').reset();
}

function closeAddOrderModal() { 
  document.getElementById('addOrderModal').style.display = 'none';
  // Reset form
  document.getElementById('addOrderForm').reset();
}

document.getElementById('addOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const productId = parseInt(document.getElementById('addProductId').value);
  const batchNumber = document.getElementById('addBatchNumber').value;
  const quantity = parseInt(document.getElementById('addOrderQuantity').value);
  const customer = document.getElementById('addCustomer').value;

  if(isNaN(productId) || isNaN(quantity) || !batchNumber || !customer) {
    alert('Please fill all fields correctly.');
    return;
  }

  fetch('/add-order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ product_id: productId, batch_number: batchNumber, order_quantity: quantity, customer: customer })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if(data.success) location.reload();
  });
});


// Edit Order Modal
function openEditOrderModal(orderId, productId, batchNumber, quantity, customer) {
  document.getElementById('editOrderId').value = orderId;
  document.getElementById('editProductId').value = productId;
  document.getElementById('editBatchNumber').value = batchNumber;
  document.getElementById('editOrderQuantity').value = quantity;
  
  // Set customer dropdown
  const customerSelect = document.getElementById('editCustomer');
  const otherGroup = document.getElementById('editOtherCustomerGroup');
  const otherInput = document.getElementById('editOtherCustomerInput');
  
  // Try to find the customer in the options
  let found = false;
  for (let option of customerSelect.options) {
    if (option.textContent === customer) {
      customerSelect.value = option.value;
      found = true;
      otherGroup.style.display = 'none';
      break;
    }
  }
  
  // If customer not found in the list, show "Other" input
  if (!found) {
    customerSelect.value = '__other__';
    otherGroup.style.display = 'block';
    otherInput.value = customer;
  }
  
  document.getElementById('editOrderModal').style.display = 'block';
}
  
function closeEditOrderModal() { 
  document.getElementById('editOrderModal').style.display = 'none';
}

document.getElementById('editOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const orderId = document.getElementById('editOrderId').value;
  const productId = document.getElementById('editProductId').value;
  const batchNumber = document.getElementById('editBatchNumber').value;
  const quantity = document.getElementById('editOrderQuantity').value;
  const customer = document.getElementById('editCustomer').value;

  fetch(`/edit-order/${orderId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ product_id: productId, batch_number: batchNumber, order_quantity: quantity, customer: customer })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if(data.success) location.reload();
  });
});

function toggleOtherCustomer(type) {
  const customerSelect = document.getElementById(type === 'add' ? 'addCustomer' : 'editCustomer');
  const otherGroup = document.getElementById(type === 'add' ? 'addOtherCustomerGroup' : 'editOtherCustomerGroup');
  
  if (customerSelect.value === '__other__') {
    otherGroup.style.display = 'block';
  } else {
    otherGroup.style.display = 'none';
  }
}

// Update add order form submission to handle "Other" option
document.getElementById('addOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  let customerValue;
  const customerSelect = document.getElementById('addCustomer');
  
  // If "Other" is selected, use the custom input value
  if (customerSelect.value === '__other__') {
    const otherCustomer = document.getElementById('addOtherCustomerInput').value;
    if (otherCustomer.trim() === '') {
      alert('Please enter a customer name');
      return;
    }
    customerValue = otherCustomer;
  } else {
    customerValue = customerSelect.value;
  }
  
  const productId = parseInt(document.getElementById('addProductId').value);
  const batchNumber = document.getElementById('addBatchNumber').value;
  const quantity = parseInt(document.getElementById('addOrderQuantity').value);

  if(isNaN(productId) || isNaN(quantity) || !batchNumber || !customerValue) {
    alert('Please fill all fields correctly.');
    return;
  }

  fetch('/add-order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      product_id: productId, 
      batch_number: batchNumber, 
      order_quantity: quantity, 
      customer: customerValue 
    })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if(data.success) location.reload();
  });
});

// Update edit order form submission to handle "Other" option
document.getElementById('editOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  let customerValue;
  const customerSelect = document.getElementById('editCustomer');
  
  // If "Other" is selected, use the custom input value
  if (customerSelect.value === '__other__') {
    const otherCustomer = document.getElementById('editOtherCustomerInput').value;
    if (otherCustomer.trim() === '') {
      alert('Please enter a customer name');
      return;
    }
    customerValue = otherCustomer;
  } else {
    customerValue = customerSelect.value;
  }
  
  const orderId = document.getElementById('editOrderId').value;
  const productId = document.getElementById('editProductId').value;
  const batchNumber = document.getElementById('editBatchNumber').value;
  const quantity = document.getElementById('editOrderQuantity').value;

  fetch(`/edit-order/${orderId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      product_id: productId, 
      batch_number: batchNumber, 
      order_quantity: quantity, 
      customer: customerValue 
    })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if(data.success) location.reload();
  });
});

// Add new function to fetch product info when invoice is selected
function updateProductInfo() {
  const invoiceNumber = document.getElementById('addInvoiceNumber').value;
  if (!invoiceNumber) {
    document.getElementById('addProductInfo').value = '';
    document.getElementById('addAvailableQty').value = '';
    return;
  }
  
  fetch(`/get-purchase-info/${invoiceNumber}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('addProductInfo').value = data.product_name;
        document.getElementById('addAvailableQty').value = data.remaining_quantity;
      } else {
        alert(data.message);
        document.getElementById('addProductInfo').value = '';
        document.getElementById('addAvailableQty').value = '';
      }
    })
    .catch(err => {
      console.error('Error:', err);
      document.getElementById('addProductInfo').value = '';
      document.getElementById('addAvailableQty').value = '';
    });
}

function updateEditProductInfo() {
  const invoiceNumber = document.getElementById('editInvoiceNumber').value;
  if (!invoiceNumber) {
    document.getElementById('editProductInfo').value = '';
    document.getElementById('editAvailableQty').value = '';
    return;
  }
  
  fetch(`/get-purchase-info/${invoiceNumber}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('editProductInfo').value = data.product_name;
        document.getElementById('editAvailableQty').value = data.remaining_quantity;
      } else {
        alert(data.message);
        document.getElementById('editProductInfo').value = '';
        document.getElementById('editAvailableQty').value = '';
      }
    })
    .catch(err => {
      console.error('Error:', err);
      document.getElementById('editProductInfo').value = '';
      document.getElementById('editAvailableQty').value = '';
    });
}

// Update the openEditOrderModal function
function openEditOrderModal(orderId, productName, invoiceNumber, quantity, customer) {
  document.getElementById('editOrderId').value = orderId;
  document.getElementById('editInvoiceNumber').value = invoiceNumber;
  document.getElementById('editOrderQuantity').value = quantity;
  document.getElementById('editProductInfo').value = productName;
  
  // Set customer dropdown
  const customerSelect = document.getElementById('editCustomer');
  const otherGroup = document.getElementById('editOtherCustomerGroup');
  const otherInput = document.getElementById('editOtherCustomerInput');
  
  // Try to find the customer in the options
  let found = false;
  for (let option of customerSelect.options) {
    if (option.textContent === customer) {
      customerSelect.value = option.value;
      found = true;
      otherGroup.style.display = 'none';
      break;
    }
  }
  
  // If customer not found in the list, show "Other" input
  if (!found) {
    customerSelect.value = '__other__';
    otherGroup.style.display = 'block';
    otherInput.value = customer;
  }
  
  // Fetch available quantity for the selected invoice
  updateEditProductInfo();
  
  document.getElementById('editOrderModal').style.display = 'block';
}

// Update form submissions to use invoice_number
document.getElementById('addOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const invoiceNumber = document.getElementById('addInvoiceNumber').value;
  const quantity = parseInt(document.getElementById('addOrderQuantity').value);
  const customer = document.getElementById('addCustomer').value;

  if(!invoiceNumber || isNaN(quantity) || !customer) {
    alert('Please fill all fields correctly.');
    return;
  }

  fetch('/add-order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ invoice_number: invoiceNumber, order_quantity: quantity, customer: customer })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if(data.success) location.reload();
  })
  .catch(err => alert('Error: ' + err));
});

document.getElementById('editOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const orderId = document.getElementById('editOrderId').value;
  const invoiceNumber = document.getElementById('editInvoiceNumber').value;
  const quantity = document.getElementById('editOrderQuantity').value;
  const customer = document.getElementById('editCustomer').value;

  fetch(`/edit-order/${orderId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ invoice_number: invoiceNumber, order_quantity: quantity, customer: customer })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if(data.success) location.reload();
  })
  .catch(err => alert('Error: ' + err));
});

// Update filter function to include invoice number
function applyOrderFilters() {
  const searchValue = document.getElementById("searchOrders").value.toLowerCase();
  const invoiceValue = document.getElementById("invoiceFilter") ? document.getElementById("invoiceFilter").value.toLowerCase() : '';
  const dateValue = document.getElementById("dateFilter").value;

  const rows = document.querySelectorAll("#ordersTable tbody tr");
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    const rowInvoice = row.getAttribute("data-invoice")?.toLowerCase();
    const rowDate = row.getAttribute("data-date");

    const matchesSearch = text.includes(searchValue);
    const matchesInvoice = !invoiceValue || rowInvoice.includes(invoiceValue);
    const matchesDate = dateValue === "" || rowDate === dateValue;

    row.style.display = matchesSearch && matchesInvoice && matchesDate ? "" : "none";
  });
}

// Delete order
function deleteOrder(orderId) {
  if(confirm('Are you sure you want to delete this order?')) {
    fetch(`/delete-order/${orderId}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if(data.success) location.reload();
      });
  }
}
</script>
{% endblock %}



