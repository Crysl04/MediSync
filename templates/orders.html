{% extends 'layout.html' %}
{% block title %}MediSync - Orders{% endblock %}

{% block content %}
<div class="main">
  <header class="dashboard-header">
    <h1>Inventory Management</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="static/profile.png" alt="Profile Picture" width="40" height="40" style="border-radius: 50%;"> 
      <div>
        <strong>{{ session['name'] }}</strong><br>
        <small>Administrator</small>
      </div>
    </div>
  </header>

  <hr class="hr-line">

  <div class="products-controls">
    <div class="filter-btn">
      <input type="text" id="searchOrders" placeholder="Search orders..." />
      <button onclick="toggleOrderFilterOptions()">
        <img src="{{ url_for('static', filename='filter.png') }}" alt="Filter Icon" class="filter-icon">
        FILTER
      </button>
      <div id="orderFilterOptions" class="filter-options" style="display: none;">
        <div class="filter-group">
          <!-- Change "Batch Number" to "Invoice Number" -->
          <label>Invoice Number:</label>
          <input type="text" id="invoiceFilter" placeholder="Enter invoice number..." />
        </div>
        <div class="filter-group">
          <label>Order Date:</label>
          <input type="date" id="dateFilter" />
        </div>
      </div>
    </div>
    <button class="add-btn" onclick="openAddOrderModal()">+ Add Order</button>
  </div>

  <div class="orders-table">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Invoice Number</th>
          <th>Delivery Date</th>
          <th>Customer</th>
          <th>Product Name</th>
          <th>Quantity</th>
          <th>Qty per Box</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if orders %}
          {% for order in orders %}
            <tr data-order-id="{{ order[0] }}" 
                data-invoice="{{ order[5] }}"
                data-quantity="{{ order[2] }}" 
                data-date="{{ order[4] }}" 
                data-customer="{{ order[5] }}">
              <td>{{ order[5] if order[5] else 'N/A' }}</td> <!-- Invoice Number -->
              <td>{{ order[4] }}</td> <!-- Order Date -->
              <td>{{ order[5] }}</td> <!-- Customer -->
              <td>{{ order[1] }}</td> <!-- Product Name -->
              <td>{{ order[2] }}</td> <!-- Quantity -->
              <td>{{ order[7] if order[7] else '1' }}</td> <!-- Quantity per Box -->
              <td>
                <button onclick="openEditOrderModal('{{ order[0] }}', '{{ order[1] }}', '{{ order[5] }}', '{{ order[2] }}', '{{ order[5] }}', '{{ order[7] if order[7] else 1 }}')">Edit</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" style="text-align: center;">No orders found</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  td button {
    margin: 2px;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  td button:first-child {
    background-color: #4CAF50;
    color: white;
  }
  td button:last-child {
    background-color: #f44336;
    color: white;
  }
  /* Style for datalist dropdown */
  datalist {
    max-height: 200px;
    overflow-y: auto;
  }
</style>

<!-- Invoice Number Datalist (for both modals) -->
<datalist id="invoiceNumbersList">
  {% for inv in invoice_data %}
    <option value="{{ inv[0] }}" 
            data-product="{{ inv[1] }}">
      {{ inv[0] }} - {{ inv[1] }}
    </option>
  {% endfor %}
</datalist>

<!-- Add Order Modal -->
<div id="addOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:400px; position:relative;">
    <h2>Add Order</h2>
    <form id="addOrderForm">
      <label>Invoice Number:</label><br>
      <input type="text" name="invoice_number" id="addInvoiceNumber" 
             list="invoiceNumbersList" 
             placeholder="Type to search invoice numbers..." 
             autocomplete="off"
             required>
      <br><br>

      <!-- Product selection dropdown (initially hidden) -->
      <div id="addProductSelectGroup" style="display:none;">
        <label>Select Product:</label><br>
        <select name="product_id" id="addProductSelect" required>
          <option value="">Select a product</option>
          <!-- Products will be populated by JavaScript -->
        </select>
        <br><br>
      </div>

      <label>Available Quantity:</label><br>
      <input type="text" id="addAvailableQty" readonly><br><br>

      <label>Order Quantity:</label><br>
      <input type="number" name="order_quantity" id="addOrderQuantity" min="1" required><br><br>

      <label>Customer:</label><br>
      <select name="customer" id="addCustomer" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer }}">{{ customer }}</option>
        {% endfor %}
        <option value="__other__">Other (enter below)</option>
      </select>
      <div id="addOtherCustomerGroup" style="display:none; margin-top:5px;">
        <input type="text" id="addOtherCustomerInput" placeholder="Enter customer name">
      </div>
      <br><br>

      <div style="text-align:right;">
        <button type="button" onclick="closeAddOrderModal()">Cancel</button>
        <button type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Order Modal -->
<div id="editOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:400px; position:relative;">
    <h2>Edit Order</h2>
    <form id="editOrderForm">
      <input type="hidden" name="order_id" id="editOrderId">

      <label>Invoice Number:</label><br>
      <input type="text" name="invoice_number" id="editInvoiceNumber" 
             list="invoiceNumbersList" 
             placeholder="Type to search invoice numbers..." 
             autocomplete="off"
             required>
      <br><br>

      <!-- Product selection dropdown (initially hidden) -->
      <div id="editProductSelectGroup" style="display:none;">
        <label>Select Product:</label><br>
        <select name="product_id" id="editProductSelect" required>
          <option value="">Select a product</option>
          <!-- Products will be populated by JavaScript -->
        </select>
        <br><br>
      </div>

      <label>Available Quantity:</label><br>
      <input type="text" id="editAvailableQty" readonly><br><br>

      <label>Order Quantity:</label><br>
      <input type="number" name="order_quantity" id="editOrderQuantity" min="1" required><br><br>

      <label>Customer:</label><br>
      <select name="customer" id="editCustomer" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer }}">{{ customer }}</option>
        {% endfor %}
        <option value="__other__">Other (enter below)</option>
      </select>
      <div id="editOtherCustomerGroup" style="display:none; margin-top:5px;">
        <input type="text" id="editOtherCustomerInput" placeholder="Enter customer name">
      </div>
      <br><br>

      <div style="text-align:right;">
        <button type="button" onclick="closeEditOrderModal()">Cancel</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
// Create a map to store invoice data for quick lookup
let invoiceDataMap = {};
let currentProductsForAdd = [];
let currentProductsForEdit = [];

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM Content Loaded - Initializing...");
  
  // Get all options from the datalist
  const datalist = document.getElementById('invoiceNumbersList');
  const options = datalist ? datalist.querySelectorAll('option') : [];
  
  // Populate the invoice data map
  options.forEach(option => {
    invoiceDataMap[option.value] = {
      product: option.getAttribute('data-product'),
      dosage: option.getAttribute('data-dosage'),
      unit: option.getAttribute('data-unit')
    };
  });
  
  console.log('Invoice data map loaded:', invoiceDataMap);
  
  // Set up form submissions and other event listeners
  setupFormHandlers();
  
  // Set up filter event listeners
  setupFilterHandlers();
});

// Filter functions
function toggleOrderFilterOptions() {
  const filterBox = document.getElementById("orderFilterOptions");
  filterBox.style.display = filterBox.style.display === "none" ? "block" : "none";
}

function applyOrderFilters() {
  console.log("applyOrderFilters called");
  
  // Check if table exists
  const table = document.getElementById("ordersTable");
  if (!table) {
    console.error("Table not found!");
    return;
  }
  
  const tbody = table.querySelector("tbody");
  if (!tbody) {
    console.error("Table body not found!");
    return;
  }
  
  const searchValue = document.getElementById("searchOrders")?.value?.toLowerCase() || '';
  const invoiceValue = document.getElementById("invoiceFilter")?.value?.toLowerCase() || '';
  const dateValue = document.getElementById("dateFilter")?.value || '';

  const rows = tbody.querySelectorAll("tr");
  if (!rows.length) {
    console.log("No rows found in table");
    return;
  }
  
  console.log(`Filtering ${rows.length} rows with search: "${searchValue}", invoice: "${invoiceValue}", date: "${dateValue}"`);
  
  rows.forEach(row => {
    if (!row) {
      console.error("Found null row!");
      return;
    }
    
    // Skip the "No orders found" row if it exists
    if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
      row.style.display = ""; // Always show the "no orders" message
      return;
    }
    
    try {
      const text = row.textContent.toLowerCase();
      const rowInvoice = row.getAttribute("data-invoice")?.toLowerCase() || '';
      const rowDate = row.getAttribute("data-date");

      const matchesSearch = !searchValue || text.includes(searchValue);
      const matchesInvoice = !invoiceValue || rowInvoice.includes(invoiceValue);
      const matchesDate = !dateValue || rowDate === dateValue;

      row.style.display = matchesSearch && matchesInvoice && matchesDate ? "" : "none";
    } catch (error) {
      console.error("Error filtering row:", error, row);
    }
  });
}

// Setup filter event handlers
function setupFilterHandlers() {
  const searchInput = document.getElementById('searchOrders');
  const invoiceFilter = document.getElementById('invoiceFilter');
  const dateFilter = document.getElementById('dateFilter');
  
  if (searchInput) {
    searchInput.addEventListener('keyup', applyOrderFilters);
    console.log("Added search filter listener");
  } else {
    console.error("searchOrders input not found!");
  }
  
  if (invoiceFilter) {
    invoiceFilter.addEventListener('keyup', applyOrderFilters);
    console.log("Added invoice filter listener");
  } else {
    console.error("invoiceFilter input not found!");
  }
  
  if (dateFilter) {
    dateFilter.addEventListener('change', applyOrderFilters);
    console.log("Added date filter listener");
  } else {
    console.error("dateFilter input not found!");
  }
}

// Add Order Modal functions
function openAddOrderModal() { 
  console.log("openAddOrderModal called");
  document.getElementById('addOrderModal').style.display = 'block';
  // Reset form
  document.getElementById('addOrderForm').reset();
  // Hide product selection group
  document.getElementById('addProductSelectGroup').style.display = 'none';
  // Clear fields
  document.getElementById('addAvailableQty').value = '';
  document.getElementById('addOrderQuantity').value = '';
  document.getElementById('addCustomer').selectedIndex = 0;
  document.getElementById('addOtherCustomerGroup').style.display = 'none';
  // Clear product dropdown
  document.getElementById('addProductSelect').innerHTML = '<option value="">Select a product</option>';
  currentProductsForAdd = [];
}

function closeAddOrderModal() { 
  document.getElementById('addOrderModal').style.display = 'none';
  document.getElementById('addOrderForm').reset();
}

// Edit Order Modal functions
function openEditOrderModal(orderId, productName, invoiceNumber, quantity, customer, quantityPerBox) {
  console.log("openEditOrderModal called with:", {orderId, productName, invoiceNumber, quantity, customer, quantityPerBox});
  
  document.getElementById('editOrderId').value = orderId;
  const editInvoiceInput = document.getElementById('editInvoiceNumber');
  editInvoiceInput.value = invoiceNumber;
  
  // Store old values for calculation
  editInvoiceInput.setAttribute('data-old-invoice', invoiceNumber);
  editInvoiceInput.setAttribute('data-old-quantity', quantity);
  
  document.getElementById('editOrderQuantity').value = quantity;
  document.getElementById('editOrderId').setAttribute('data-quantity-per-box', quantityPerBox);
  
  // Set customer dropdown
  const customerSelect = document.getElementById('editCustomer');
  const otherGroup = document.getElementById('editOtherCustomerGroup');
  const otherInput = document.getElementById('editOtherCustomerInput');
  
  // Try to find the customer in the options
  let found = false;
  for (let option of customerSelect.options) {
    if (option.textContent === customer) {
      customerSelect.value = option.value;
      found = true;
      otherGroup.style.display = 'none';
      break;
    }
  }
  
  // If customer not found in the list, show "Other" input
  if (!found) {
    customerSelect.value = '__other__';
    otherGroup.style.display = 'block';
    otherInput.value = customer;
  }
  
  // Fetch products for this invoice
  fetchProductsForInvoice('edit', invoiceNumber, productName);
  
  document.getElementById('editOrderModal').style.display = 'block';
}
  
function closeEditOrderModal() { 
  document.getElementById('editOrderModal').style.display = 'none';
}

// Toggle other customer input
function toggleOtherCustomer(type) {
  const customerSelect = document.getElementById(type === 'add' ? 'addCustomer' : 'editCustomer');
  const otherGroup = document.getElementById(type === 'add' ? 'addOtherCustomerGroup' : 'editOtherCustomerGroup');
  
  if (customerSelect.value === '__other__') {
    otherGroup.style.display = 'block';
  } else {
    otherGroup.style.display = 'none';
  }
}

// Fetch products for a specific invoice number
function fetchProductsForInvoice(type, presetInvoice = null, presetProductName = null) {
  console.log(`fetchProductsForInvoice called for type: ${type}, presetInvoice: ${presetInvoice}`);
  
  let invoiceInput, productSelect, productSelectGroup, productsArray;
  
  if (type === 'add') {
    invoiceInput = document.getElementById('addInvoiceNumber');
    productSelect = document.getElementById('addProductSelect');
    productSelectGroup = document.getElementById('addProductSelectGroup');
    productsArray = currentProductsForAdd;
  } else {
    invoiceInput = document.getElementById('editInvoiceNumber');
    productSelect = document.getElementById('editProductSelect');
    productSelectGroup = document.getElementById('editProductSelectGroup');
    productsArray = currentProductsForEdit;
  }
  
  const invoiceNumber = presetInvoice || (invoiceInput ? invoiceInput.value.trim() : '');
  
  if (!invoiceNumber || invoiceNumber.length < 3) {
    if (productSelectGroup) productSelectGroup.style.display = 'none';
    if (productSelect) productSelect.innerHTML = '<option value="">Select a product</option>';
    
    if (type === 'add') {
      const availableQty = document.getElementById('addAvailableQty');
      if (availableQty) availableQty.value = '';
    } else {
      const availableQty = document.getElementById('editAvailableQty');
      if (availableQty) availableQty.value = '';
    }
    return;
  }
  
  // Fetch all products for this invoice number
  fetch(`/get-products-by-invoice/${encodeURIComponent(invoiceNumber)}`)
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.json();
    })
    .then(data => {
      console.log('Products data received:', data);
      if (data.success && data.products && data.products.length > 0) {
        // Clear previous products
        productsArray.length = 0;
        
        // Populate the product dropdown
        if (productSelect) {
          productSelect.innerHTML = '<option value="">Select a product</option>';
          
          data.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.product_id;
            // Format: "Product Name (Dosage) [Unit] - X pcs/box"
            let displayText = product.product_name;

            displayText += ` - ${product.quantity_per_box || 1} pcs/box`;
            option.textContent = displayText;
            option.setAttribute('data-remaining', product.remaining_quantity);
            option.setAttribute('data-batch', product.batch_number);
            option.setAttribute('data-product-name', product.product_name);
            option.setAttribute('data-quantity-per-box', product.quantity_per_box || 1);
            productSelect.appendChild(option);
            
            // Store product data in array for later use
            productsArray.push({
              product_id: product.product_id,
              product_name: product.product_name,
              remaining_quantity: product.remaining_quantity,
              batch_number: product.batch_number,
              quantity_per_box: product.quantity_per_box || 1
            });
          });
        }
        
        // Show the product selection dropdown
        if (productSelectGroup) {
          productSelectGroup.style.display = 'block';
        }
        
        // If we have a preset product (for edit mode), select it
        if (presetProductName && presetDosage !== undefined && presetUnit !== undefined && productSelect) {
          // Try to find the matching product
          let foundIndex = -1;
          for (let i = 0; i < productsArray.length; i++) {
            const product = productsArray[i];
            if (product.product_name === presetProductName) {
              foundIndex = i;
              break;
            }
          }
          
          if (foundIndex !== -1) {
            productSelect.selectedIndex = foundIndex + 1; // +1 because of the "Select a product" option
            updateAvailableQuantityForEdit();
          }
        }
        
        // Clear error styling
        if (invoiceInput) invoiceInput.style.borderColor = '';
      } else {
        if (productSelectGroup) productSelectGroup.style.display = 'none';
        if (productSelect) productSelect.innerHTML = '<option value="">Select a product</option>';
        
        if (type === 'add') {
          const availableQty = document.getElementById('addAvailableQty');
          if (availableQty) availableQty.value = '';
        } else {
          const availableQty = document.getElementById('editAvailableQty');
          if (availableQty) availableQty.value = '';
        }
        
        // Show error styling
        if (invoiceInput) invoiceInput.style.borderColor = '#ff4444';
      }
    })
    .catch(err => {
      console.error('Error fetching products:', err);
      if (productSelectGroup) productSelectGroup.style.display = 'none';
      if (productSelect) productSelect.innerHTML = '<option value="">Select a product</option>';
      
      if (type === 'add') {
        const availableQty = document.getElementById('addAvailableQty');
        if (availableQty) availableQty.value = '';
      } else {
        const availableQty = document.getElementById('editAvailableQty');
        if (availableQty) availableQty.value = '';
      }
    });
}

// Update available quantity when a product is selected (Add modal)
function updateAvailableQuantityForAdd() {
  const productSelect = document.getElementById('addProductSelect');
  const availableQty = document.getElementById('addAvailableQty');
  
  if (!productSelect || !availableQty) return;
  
  const selectedIndex = productSelect.selectedIndex;
  
  if (selectedIndex > 0) {
    const selectedOption = productSelect.options[selectedIndex];
    const remaining = selectedOption.getAttribute('data-remaining');
    availableQty.value = remaining;
  } else {
    availableQty.value = '';
  }
}

// Update available quantity when a product is selected (Edit modal)
function updateAvailableQuantityForEdit() {
  const productSelect = document.getElementById('editProductSelect');
  const availableQty = document.getElementById('editAvailableQty');
  const editInvoiceInput = document.getElementById('editInvoiceNumber');
  
  if (!productSelect || !availableQty || !editInvoiceInput) return;
  
  const selectedIndex = productSelect.selectedIndex;
  const oldInvoice = editInvoiceInput.getAttribute('data-old-invoice');
  const oldQuantity = parseInt(editInvoiceInput.getAttribute('data-old-quantity') || 0);
  const currentInvoice = editInvoiceInput.value.trim();
  
  if (selectedIndex > 0) {
    const selectedOption = productSelect.options[selectedIndex];
    const remaining = parseInt(selectedOption.getAttribute('data-remaining'));
    
    let available = remaining;
    
    // If editing the same invoice, add back the old order quantity
    if (currentInvoice === oldInvoice) {
      available += oldQuantity;
    }
    
    availableQty.value = available;
  } else {
    availableQty.value = '';
  }
}

// Setup form handlers
function setupFormHandlers() {
  console.log("Setting up form handlers...");
  
  // Add Order Form Submission
  const addOrderForm = document.getElementById('addOrderForm');
  if (addOrderForm) {
    addOrderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log("Add order form submitted");
      
      let customerValue;
      const customerSelect = document.getElementById('addCustomer');
      
      if (!customerSelect) {
        alert('Customer select not found');
        return;
      }
      
      // If "Other" is selected, use the custom input value
      if (customerSelect.value === '__other__') {
        const otherCustomer = document.getElementById('addOtherCustomerInput')?.value;
        if (!otherCustomer || otherCustomer.trim() === '') {
          alert('Please enter a customer name');
          return;
        }
        customerValue = otherCustomer;
      } else {
        customerValue = customerSelect.value;
      }
      
      const invoiceNumber = document.getElementById('addInvoiceNumber')?.value.trim();
      const productSelect = document.getElementById('addProductSelect');
      const productId = productSelect?.value;
      const quantity = parseInt(document.getElementById('addOrderQuantity')?.value || 0);

      if(!invoiceNumber || !productId || isNaN(quantity) || quantity <= 0 || !customerValue) {
        alert('Please fill all fields correctly.');
        return;
      }
      
      // Get batch number and product name from selected product
      const selectedProduct = currentProductsForAdd.find(p => p.product_id == productId);
      if (!selectedProduct) {
        alert('Please select a valid product.');
        return;
      }
      
      // Validate quantity
      const availableQtyElem = document.getElementById('addAvailableQty');
      if (!availableQtyElem) {
        alert('Available quantity field not found');
        return;
      }
      
      const availableQty = parseInt(availableQtyElem.value);
      if (isNaN(availableQty)) {
        alert('Cannot determine available quantity. Please select a product.');
        return;
      }
      
      if (quantity > availableQty) {
        alert(`Order quantity cannot exceed available quantity (${availableQty}).`);
        return;
      }
      
      // Disable the submit button to prevent double submission
      const submitButton = this.querySelector('button[type="submit"]');
      if (!submitButton) {
        alert('Submit button not found');
        return;
      }
      
      const originalText = submitButton.textContent;
      submitButton.textContent = 'Processing...';
      submitButton.disabled = true;
      
      fetch('/add-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          invoice_number: invoiceNumber, 
          product_id: productId,
          batch_number: selectedProduct.batch_number,
          product_name: selectedProduct.product_name,
          quantity_per_box: selectedProduct.quantity_per_box,
          order_quantity: quantity, 
          customer: customerValue 
        })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if(data.success) {
          location.reload();
        } else {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error: ' + err);
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      });
      
      return false;
    });
  } else {
    console.error("Add order form not found!");
  }

  // Edit Order Form Submission
  const editOrderForm = document.getElementById('editOrderForm');
  if (editOrderForm) {
    editOrderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log("Edit order form submitted");
      
      let customerValue;
      const customerSelect = document.getElementById('editCustomer');
      
      if (!customerSelect) {
        alert('Customer select not found');
        return;
      }
      
      // If "Other" is selected, use the custom input value
      if (customerSelect.value === '__other__') {
        const otherCustomer = document.getElementById('editOtherCustomerInput')?.value;
        if (!otherCustomer || otherCustomer.trim() === '') {
          alert('Please enter a customer name');
          return;
        }
        customerValue = otherCustomer;
      } else {
        customerValue = customerSelect.value;
      }
      
      const orderId = document.getElementById('editOrderId')?.value;
      const invoiceNumber = document.getElementById('editInvoiceNumber')?.value.trim();
      const productSelect = document.getElementById('editProductSelect');
      const productId = productSelect?.value;
      const quantity = parseInt(document.getElementById('editOrderQuantity')?.value || 0);

      if (!orderId || !invoiceNumber || !productId || isNaN(quantity) || quantity <= 0) {
        alert('Please fill all fields correctly.');
        return;
      }
      
      // Get batch number and product name from selected product
      const selectedProduct = currentProductsForEdit.find(p => p.product_id == productId);
      if (!selectedProduct) {
        alert('Please select a valid product.');
        return;
      }
      
      // Validate quantity
      const availableQtyElem = document.getElementById('editAvailableQty');
      if (!availableQtyElem) {
        alert('Available quantity field not found');
        return;
      }
      
      const availableQty = parseInt(availableQtyElem.value);
      if (isNaN(availableQty)) {
        alert('Cannot determine available quantity. Please select a product.');
        return;
      }
      
      if (quantity > availableQty) {
        alert(`Order quantity cannot exceed available quantity (${availableQty}).`);
        return;
      }
      
      // Disable the submit button to prevent double submission
      const submitButton = this.querySelector('button[type="submit"]');
      if (!submitButton) {
        alert('Submit button not found');
        return;
      }
      
      const originalText = submitButton.textContent;
      submitButton.textContent = 'Processing...';
      submitButton.disabled = true;
      
      fetch(`/edit-order/${orderId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          invoice_number: invoiceNumber, 
          product_id: productId,
          batch_number: selectedProduct.batch_number,
          product_name: selectedProduct.product_name,
          quantity_per_box: selectedProduct.quantity_per_box,
          order_quantity: quantity, 
          customer: customerValue 
        })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if(data.success) {
          location.reload();
        } else {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error: ' + err);
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      });
      
      return false;
    });
  } else {
    console.error("Edit order form not found!");
  }
  
  // Add event listeners for invoice inputs and product selects
  const addInvoiceInput = document.getElementById('addInvoiceNumber');
  const editInvoiceInput = document.getElementById('editInvoiceNumber');
  const addProductSelect = document.getElementById('addProductSelect');
  const editProductSelect = document.getElementById('editProductSelect');
  const addCustomerSelect = document.getElementById('addCustomer');
  const editCustomerSelect = document.getElementById('editCustomer');
  
  // Add invoice input listeners
  [addInvoiceInput, editInvoiceInput].forEach(input => {
    if (input) {
      let timer;
      input.addEventListener('input', function() {
        clearTimeout(timer);
        timer = setTimeout(() => {
          const type = this.id === 'addInvoiceNumber' ? 'add' : 'edit';
          fetchProductsForInvoice(type);
        }, 500);
      });
    }
  });
  
  // Add product select change listeners
  if (addProductSelect) {
    addProductSelect.addEventListener('change', updateAvailableQuantityForAdd);
  }
  
  if (editProductSelect) {
    editProductSelect.addEventListener('change', updateAvailableQuantityForEdit);
  }
  
  // Add customer change listeners
  if (addCustomerSelect) {
    addCustomerSelect.addEventListener('change', function() {
      toggleOtherCustomer('add');
    });
  }
  
  if (editCustomerSelect) {
    editCustomerSelect.addEventListener('change', function() {
      toggleOtherCustomer('edit');
    });
  }
  
  console.log("Form handlers setup complete");
}

// Delete order
function deleteOrder(orderId) {
  if(confirm('Are you sure you want to delete this order?')) {
    fetch(`/delete-order/${orderId}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if(data.success) location.reload();
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error deleting order: ' + err);
      });
  }
}
</script>
{% endblock %}

