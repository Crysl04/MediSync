{% extends 'layout.html' %}
{% block title %}MediSync - Orders{% endblock %}

{% block content %}
<div class="main">
  <header class="dashboard-header">
    <h1>Orders</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="static/profile.png" alt="Profile Picture" width="40" height="40" style="border-radius: 50%;"> 
      <div>
        <strong>{{ session['name'] }}</strong><br>
        <small>Administrator</small>
      </div>
    </div>
  </header>

  <hr class="hr-line">

  <div class="products-controls">
    <div class="filter-btn">
      <input type="text" id="searchOrders" placeholder="Search orders..." />
      <button onclick="toggleOrderFilterOptions()">
        <img src="{{ url_for('static', filename='filter.png') }}" alt="Filter Icon" class="filter-icon">
        FILTER
      </button>
      <div id="orderFilterOptions" class="filter-options" style="display: none;">
        <div class="filter-group">
          <label>Invoice Number:</label>
          <input type="text" id="invoiceFilter" placeholder="Enter invoice number..." />
        </div>
        <div class="filter-group">
          <label>Order Date:</label>
          <input type="date" id="dateFilter" />
        </div>
      </div>
    </div>
    <button class="add-btn" onclick="openAddOrderModal()">+ Add Order</button>
  </div>

  <div class="orders-table">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Invoice Number</th>
          <th>Delivery Date</th>
          <th>Customer</th>
          <th>Product Name</th>
          <th>Dosage</th>
          <th>Quantity</th>
          <th>Batch Number</th>
          <th>Qty per Box</th>
          <th>Unit</th>
          <th>Selling Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      
      <tbody>
        {% if orders %}
          {% for order in orders %}
            <tr data-order-id="{{ order[0] }}" 
                data-product-id="{{ order[11] }}"
                data-batch="{{ order[3] }}"
                data-invoice="{{ order[6] }}"
                data-quantity="{{ order[2] }}" 
                data-date="{{ order[4] }}" 
                data-customer="{{ order[5] }}"
                data-qty-per-box="{{ order[9] }}">
              <td>{{ order[6] if order[6] else 'N/A' }}</td> <!-- Invoice Number -->
              <td>{{ order[4] }}</td> <!-- Order Date -->
              <td>{{ order[5] }}</td> <!-- Customer -->
              <td>{{ order[1] }}</td> <!-- Product Name -->
              <td>{{ order[8] if order[8] else '' }}</td> <!-- Dosage -->
              <td>{{ order[2] }}</td> <!-- Quantity -->
              <td>{{ order[3] }}</td> <!-- Batch Number -->
              <td>{{ order[9] if order[9] else '1' }}</td> <!-- Quantity per Box -->
              <td>{{ order[7] if order[7] else 'N/A' }}</td> <!-- Unit -->
              <td>₱{{ "%.2f"|format(order[10]) if order[10] else '0.00' }}</td> <!-- Selling Price -->
              <td>
                <button onclick="editOrderRow({{ order[0] }})">Edit</button>
                <button onclick="event.stopPropagation(); deleteOrder('{{ order[0] }}')">Delete</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="11" style="text-align: center;">No orders found</td> 
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  .orders-table table {
    font-size: 13px; 
  }
  
  .orders-table th {
    font-size: 12px;
    padding: 6px 8px;
  }
  
  /* Default cell styling with truncation */
  .orders-table td {
    font-size: 13px;
    padding: 6px 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px; /* Adjust as needed */
  }
  
  /* Expanded cell – show full content */
  .orders-table td.expanded {
    white-space: normal;
    overflow: visible;
    text-overflow: clip;
    max-width: none;
    background-color: #f8f9fa; /* Optional highlight */
  }
  
  /* Make action buttons smaller */
  td button {
    margin: 1px;
    padding: 3px 6px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 11px;
  }
  
  td button:first-child {
    background-color: #4CAF50;
    color: white;
  }
  td button:last-child {
    background-color: #f44336;
    color: white;
  }
  
  /* Keep action buttons always visible and not expandable */
  .orders-table td:last-child {
    white-space: nowrap;
    max-width: none;
    cursor: default;
  }
</style>

<!-- Datalist for product search -->
<datalist id="productsDatalist">
  {% for prod in products %}
    <option value="{{ prod[1] }}{% if prod[2] %} - {{ prod[2] }}{% endif %} [{{ prod[3] or 'N/A' }}]" 
            data-id="{{ prod[0] }}" 
            data-stock="{{ prod[4] }}"
            data-dosage="{{ prod[2] or '' }}"
            data-unit="{{ prod[3] or '' }}">
  {% endfor %}
</datalist>

<!-- Add Order Modal (two-column) -->
<div id="addOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:28px 32px; border-radius:10px; width:760px; max-width:95vw; position:relative;">
    <h2>Add Order</h2>
    <form id="addOrderForm">
      <input type="hidden" name="product_id" id="addProductIdInput">
    
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        
        <!-- LEFT COLUMN -->
        <div>
          <h4>Order Details</h4>
    
          <label>Order Invoice Number:</label>
          <input type="text" name="order_invoice" id="addOrderInvoice" required>
    
          <label>Product:</label>
          <input type="text" id="addProductSearch" list="productsDatalist"
                 placeholder="Type to search products..." required>
    
          <div id="addBatchGroup" style="display:none;">
            <label>Batch Number:</label>
            <select name="batch_number" id="addBatchSelect" required>
              <option value="">Select a batch</option>
            </select>
          </div>
    
          <label>Order Quantity:</label>
          <input type="number" name="order_quantity" id="addOrderQuantity" min="1" required>
        </div>
    
        <!-- RIGHT COLUMN -->
        <div>
          <h4>Pricing & Customer</h4>
    
          <label>Available Stock (total):</label>
          <input type="text" id="addTotalStock" readonly>
    
          <label>Selling Price (₱):</label>
          <input type="number" name="selling_price" id="addSellingPrice" min="0" step="0.01" value="0.00">
    
          <label>Customer:</label>
          <select name="customer" id="addCustomer" required>
            <option value="">Select Customer</option>
            {% for customer in customers %}
              <option value="{{ customer }}">{{ customer }}</option>
            {% endfor %}
            <option value="__other__">Other (enter below)</option>
          </select>
          <div id="addOtherCustomerGroup" style="display:none; margin-top:5px;">
            <input type="text" id="addOtherCustomerInput" placeholder="Enter customer name">
          </div>
        </div>
    
      </div>
    
      <!-- BUTTONS -->
      <div style="text-align:right; margin-top:20px;">
        <button type="button" onclick="closeAddOrderModal()">Cancel</button>
        <button type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Order Modal (two-column) -->
<div id="editOrderModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:28px 32px; border-radius:10px; width:760px; max-width:95vw; position:relative;">
    <h2>Edit Order</h2>
    <form id="editOrderForm">
      <input type="hidden" name="order_id" id="editOrderId">
      <input type="hidden" name="product_id" id="editProductIdInput">
    
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        
        <!-- LEFT COLUMN -->
        <div>
          <h4>Order Details</h4>
    
          <label>Invoice Number:</label>   <!-- key must be 'invoice_number' for backend -->
          <input type="text" name="invoice_number" id="editOrderInvoice" required>
    
          <label>Product:</label>
          <input type="text" id="editProductSearch" list="productsDatalist"
                 placeholder="Type to search products..." required>
    
          <div id="editBatchGroup" style="display:none;">
            <label>Batch Number:</label>
            <select name="batch_number" id="editBatchSelect" required>
              <option value="">Select a batch</option>
            </select>
          </div>
    
          <label>Order Quantity:</label>
          <input type="number" name="order_quantity" id="editOrderQuantity" min="1" required>
        </div>
    
        <!-- RIGHT COLUMN -->
        <div>
          <h4>Pricing & Customer</h4>
    
          <label>Available Stock (total):</label>
          <input type="text" id="editTotalStock" readonly>
    
          <label>Selling Price (₱):</label>
          <input type="number" name="selling_price" id="editSellingPrice" min="0" step="0.01" value="0.00">
    
          <label>Customer:</label>
          <select name="customer" id="editCustomer" required>
            <option value="">Select Customer</option>
            {% for customer in customers %}
              <option value="{{ customer }}">{{ customer }}</option>
            {% endfor %}
            <option value="__other__">Other (enter below)</option>
          </select>
          <div id="editOtherCustomerGroup" style="display:none; margin-top:5px;">
            <input type="text" id="editOtherCustomerInput" placeholder="Enter customer name">
          </div>
        </div>
    
      </div>
    
      <!-- BUTTONS -->
      <div style="text-align:right; margin-top:20px;">
        <button type="button" onclick="closeEditOrderModal()">Cancel</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
// Global variables
let productDataMap = {};        // search text -> {id, stock, dosage, unit}
let productStockMap = {};       // id -> stock (for quick lookup)
let productDetailsMap = {};     // id -> {dosage, unit} (for batch fetching)

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM Content Loaded - Initializing...");

  // Build product maps from datalist options
  const datalist = document.getElementById('productsDatalist');
  if (datalist) {
    Array.from(datalist.options).forEach(opt => {
      const id = opt.getAttribute('data-id');
      const stock = opt.getAttribute('data-stock');
      const dosage = opt.getAttribute('data-dosage');
      const unit = opt.getAttribute('data-unit');
      const searchText = opt.value; // the displayed text
      productDataMap[searchText] = { id, stock, dosage, unit };
      productStockMap[id] = stock;
      productDetailsMap[id] = { dosage, unit };
    });
  }

  // Set up product search listeners
  setupProductSearch('add');
  setupProductSearch('edit');

  // Set up filter listeners
  setupFilterHandlers();

  // Set up form submissions
  setupFormHandlers();

  // Customer "other" toggle
  document.getElementById('addCustomer').addEventListener('change', function() {
    toggleOtherCustomer('add');
  });
  document.getElementById('editCustomer').addEventListener('change', function() {
    toggleOtherCustomer('edit');
  });

  // === EXPANDABLE ROWS (like products page) ===
  try {
    const table = document.getElementById('ordersTable');
    if (table) {
      const cells = table.getElementsByTagName('td');
      for (let cell of cells) {
        // Skip action column cells (last column)
        if (cell.cellIndex === table.rows[0].cells.length - 1) continue;
        
        cell.addEventListener('click', function() {
          // Remove expanded class from all cells
          for (let c of cells) {
            c.classList.remove('expanded');
          }
          // Toggle on the clicked cell
          this.classList.toggle('expanded');
        });
      }
    }
  } catch (e) {
    console.error('Expandable rows error (orders):', e);
  }
  // === END OF EXPANDABLE ROWS ===
});

function setupProductSearch(mode) {
  const searchInput = document.getElementById(mode === 'add' ? 'addProductSearch' : 'editProductSearch');
  const productIdInput = document.getElementById(mode === 'add' ? 'addProductIdInput' : 'editProductIdInput');
  const totalStockInput = document.getElementById(mode === 'add' ? 'addTotalStock' : 'editTotalStock');

  searchInput.addEventListener('input', function() {
    // Clear product ID if user types
    productIdInput.value = '';
    totalStockInput.value = '';
    // Hide batch group
    const batchGroup = document.getElementById(mode === 'add' ? 'addBatchGroup' : 'editBatchGroup');
    batchGroup.style.display = 'none';
  });

  searchInput.addEventListener('change', function() {
    const selectedText = this.value;
    const product = productDataMap[selectedText];
    if (product) {
      productIdInput.value = product.id;
      totalStockInput.value = product.stock || 0;
      // Fetch batches for this product
      fetchBatchesForProduct(product.id, mode);
    } else {
      productIdInput.value = '';
      totalStockInput.value = '';
    }
  });
}

// Fetch batches for a given product (returns promise)
function fetchBatchesForProduct(productId, mode) {
  return fetch(`/get-batches-for-product/${productId}`)
    .then(res => res.json())
    .then(data => {
      const batchSelect = document.getElementById(mode === 'add' ? 'addBatchSelect' : 'editBatchSelect');
      const batchGroup = document.getElementById(mode === 'add' ? 'addBatchGroup' : 'editBatchGroup');
      batchSelect.innerHTML = '<option value="">Select a batch</option>';
      if (data.success && data.batches.length > 0) {
        data.batches.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.batch;
          opt.textContent = `${b.batch} (Remaining: ${b.remaining})`;
          opt.setAttribute('data-remaining', b.remaining);
          batchSelect.appendChild(opt);
        });
        batchGroup.style.display = 'block';
      } else {
        batchGroup.style.display = 'none';
      }
    })
    .catch(err => console.error('Error fetching batches:', err));
}

// Add Order Modal
function openAddOrderModal() {
  document.getElementById('addOrderModal').style.display = 'block';
  document.getElementById('addOrderForm').reset();
  document.getElementById('addProductIdInput').value = '';
  document.getElementById('addTotalStock').value = '';
  document.getElementById('addBatchGroup').style.display = 'none';
  document.getElementById('addOtherCustomerGroup').style.display = 'none';
}

function closeAddOrderModal() {
  document.getElementById('addOrderModal').style.display = 'none';
}

// Edit Order Modal
function editOrderRow(orderId) {
  const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
  if (!row) return;

  const productId = row.getAttribute('data-product-id');
  const batchNumber = row.getAttribute('data-batch');
  const invoice = row.getAttribute('data-invoice');
  const quantity = row.getAttribute('data-quantity');
  const customer = row.getAttribute('data-customer');
  const qtyPerBox = row.getAttribute('data-qty-per-box') || '1';
  const sellingPrice = parseFloat(row.cells[9].textContent.replace('₱', '')) || 0; // index 9 = selling price

  // Set basic fields
  document.getElementById('editOrderId').value = orderId;
  document.getElementById('editOrderInvoice').value = invoice;   // invoice_number input
  document.getElementById('editOrderQuantity').value = quantity;
  document.getElementById('editSellingPrice').value = sellingPrice.toFixed(2);

  // Store qtyPerBox in a hidden attribute for later use
  document.getElementById('editOrderForm').setAttribute('data-qty-per-box', qtyPerBox);

  // Set product search field
  const productDetails = productDetailsMap[productId] || { dosage: '', unit: '' };
  const productOption = Object.keys(productDataMap).find(key => productDataMap[key].id == productId);
  const productSearch = document.getElementById('editProductSearch');
  if (productOption) {
    productSearch.value = productOption;
  } else {
    // Fallback: use product name from row
    productSearch.value = row.cells[3].textContent; // product name column
  }
  document.getElementById('editProductIdInput').value = productId;
  const stock = productStockMap[productId] || 0;
  document.getElementById('editTotalStock').value = stock;

  // Fetch batches and then pre-select the correct batch
  fetchBatchesForProduct(productId, 'edit').then(() => {
    const batchSelect = document.getElementById('editBatchSelect');
    for (let opt of batchSelect.options) {
      if (opt.value === batchNumber) {
        opt.selected = true;
        break;
      }
    }
  });

  // Set customer dropdown
  const customerSelect = document.getElementById('editCustomer');
  const otherGroup = document.getElementById('editOtherCustomerGroup');
  const otherInput = document.getElementById('editOtherCustomerInput');
  let found = false;
  for (let opt of customerSelect.options) {
    if (opt.textContent === customer) {
      customerSelect.value = opt.value;
      found = true;
      otherGroup.style.display = 'none';
      break;
    }
  }
  if (!found) {
    customerSelect.value = '__other__';
    otherGroup.style.display = 'block';
    otherInput.value = customer;
  }

  document.getElementById('editOrderModal').style.display = 'block';
}

function closeEditOrderModal() {
  document.getElementById('editOrderModal').style.display = 'none';
}

// Toggle other customer input
function toggleOtherCustomer(mode) {
  const customerSelect = document.getElementById(mode === 'add' ? 'addCustomer' : 'editCustomer');
  const otherGroup = document.getElementById(mode === 'add' ? 'addOtherCustomerGroup' : 'editOtherCustomerGroup');
  otherGroup.style.display = customerSelect.value === '__other__' ? 'block' : 'none';
}

// Filter functions
function toggleOrderFilterOptions() {
  const filterBox = document.getElementById("orderFilterOptions");
  filterBox.style.display = filterBox.style.display === "none" ? "block" : "none";
}

function applyOrderFilters() {
  const searchValue = document.getElementById("searchOrders")?.value?.toLowerCase() || '';
  const invoiceValue = document.getElementById("invoiceFilter")?.value?.toLowerCase() || '';
  const dateValue = document.getElementById("dateFilter")?.value || '';
  const rows = document.querySelectorAll("#ordersTable tbody tr");

  rows.forEach(row => {
    if (row.cells.length === 1 && row.cells[0].colSpan > 1) return; // keep "no orders" row

    const text = row.textContent.toLowerCase();
    const rowInvoice = row.getAttribute("data-invoice")?.toLowerCase() || '';
    const rowDate = row.getAttribute("data-date");

    const matchesSearch = !searchValue || text.includes(searchValue);
    const matchesInvoice = !invoiceValue || rowInvoice.includes(invoiceValue);
    const matchesDate = !dateValue || rowDate === dateValue;

    row.style.display = matchesSearch && matchesInvoice && matchesDate ? "" : "none";
  });
}

function setupFilterHandlers() {
  const searchInput = document.getElementById('searchOrders');
  const invoiceFilter = document.getElementById('invoiceFilter');
  const dateFilter = document.getElementById('dateFilter');
  
  if (searchInput) searchInput.addEventListener('keyup', applyOrderFilters);
  if (invoiceFilter) invoiceFilter.addEventListener('keyup', applyOrderFilters);
  if (dateFilter) dateFilter.addEventListener('change', applyOrderFilters);
}

// Form submissions
function setupFormHandlers() {
  // Add Order
  const addForm = document.getElementById('addOrderForm');
  addForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const orderInvoice = document.getElementById('addOrderInvoice').value.trim();
    const productId = document.getElementById('addProductIdInput').value;
    const batchSelect = document.getElementById('addBatchSelect');
    const batchNumber = batchSelect.value;
    const quantity = parseInt(document.getElementById('addOrderQuantity').value);
    const sellingPrice = parseFloat(document.getElementById('addSellingPrice').value);
    let customer = document.getElementById('addCustomer').value;
    if (customer === '__other__') {
      customer = document.getElementById('addOtherCustomerInput').value.trim();
      if (!customer) {
        alert('Please enter a customer name');
        return;
      }
    }

    if (!orderInvoice || !productId || !batchNumber || !quantity || !customer) {
      alert('Please fill all fields correctly.');
      return;
    }

    const totalStock = parseInt(document.getElementById('addTotalStock').value);
    if (quantity > totalStock) {
      alert(`Order quantity cannot exceed total stock (${totalStock}).`);
      return;
    }

    const selectedOption = batchSelect.selectedOptions[0];
    const batchRemaining = parseInt(selectedOption.getAttribute('data-remaining'));
    if (quantity > batchRemaining) {
      alert(`Order quantity exceeds remaining quantity of this batch (${batchRemaining}).`);
      return;
    }

    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    fetch('/add-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_invoice: orderInvoice,
        product_id: productId,
        batch_number: batchNumber,
        order_quantity: quantity,
        customer: customer,
        selling_price: sellingPrice
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      if (data.success) location.reload();
      else {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add';
      }
    })
    .catch(err => {
      alert('Error: ' + err);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add';
    });
  });

  // Edit Order
  const editForm = document.getElementById('editOrderForm');
  editForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const orderId = document.getElementById('editOrderId').value;
    const invoiceNumber = document.getElementById('editOrderInvoice').value.trim();  // key: invoice_number
    const productId = document.getElementById('editProductIdInput').value;
    const batchSelect = document.getElementById('editBatchSelect');
    const batchNumber = batchSelect.value;
    const quantity = parseInt(document.getElementById('editOrderQuantity').value);
    const sellingPrice = parseFloat(document.getElementById('editSellingPrice').value);
    const qtyPerBox = this.getAttribute('data-qty-per-box') || '1';  // from original order

    let customer = document.getElementById('editCustomer').value;
    if (customer === '__other__') {
      customer = document.getElementById('editOtherCustomerInput').value.trim();
      if (!customer) {
        alert('Please enter a customer name');
        return;
      }
    }

    if (!orderId || !invoiceNumber || !productId || !batchNumber || !quantity || !customer) {
      alert('Please fill all fields correctly.');
      return;
    }

    const totalStock = parseInt(document.getElementById('editTotalStock').value);
    if (quantity > totalStock) {
      alert(`Order quantity cannot exceed total stock (${totalStock}).`);
      return;
    }

    const selectedOption = batchSelect.selectedOptions[0];
    const batchRemaining = parseInt(selectedOption.getAttribute('data-remaining'));
    if (quantity > batchRemaining) {
      alert(`Order quantity exceeds remaining quantity of this batch (${batchRemaining}).`);
      return;
    }

    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    fetch(`/edit-order/${orderId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        invoice_number: invoiceNumber,    // must match backend key
        product_id: productId,
        batch_number: batchNumber,
        order_quantity: quantity,
        customer: customer,
        selling_price: sellingPrice,
        quantity_per_box: parseInt(qtyPerBox)
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      if (data.success) location.reload();
      else {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save';
      }
    })
    .catch(err => {
      alert('Error: ' + err);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save';
    });
  });
}

// Delete order
function deleteOrder(orderId) {
  if (confirm('Are you sure you want to delete this order?')) {
    fetch(`/delete-order/${orderId}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) location.reload();
      })
      .catch(err => alert('Error deleting order: ' + err));
  }
}
</script>
{% endblock %}
