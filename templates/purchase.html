{% extends 'layout.html' %}
{% block title %}MediSync - Purchases{% endblock %}

{% block content %}

<div class="main">
  <header class="dashboard-header">
    <h1>Inventory Management</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="static//profile.png"            
          alt="Profile Picture" width="40" height="40" style="border-radius: 50%;"> 
      <div>
        <strong>{{ session['name'] }}</strong><br>
        <small>Administrator</small>
      </div>
    </div>
  </header>
  
  <hr class="hr-line">

  <div class="products-controls">
    <div class="filter-btn">
      <input type="text" id="searchInput" placeholder="Search purchases..." onkeyup="searchPurchasesTable()" />
      <button onclick="togglePurchaseFilters()">
        <img src="{{ url_for('static', filename='filter.png') }}" alt="Filter Icon" class="filter-icon">
        FILTER
      </button>
      <div id="purchaseFilterOptions" class="filter-options" style="display: none;">
        <div class="filter-group">
          <label>Batch Number:</label>
          <input type="text" id="batchFilter" onkeyup="applyPurchaseFilters()" placeholder="Filter by batch number" />
        </div>
        <div class="filter-group">
          <label>Status:</label>
          <select id="statusFilter" onchange="applyPurchaseFilters()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="sold-out">Sold-out</option>
            <option value="near-expiry">Near-expiry</option>
            <option value="expired">Expired</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Purchase Date:</label>
          <input type="date" id="dateFilter" onchange="applyPurchaseFilters()" />
        </div>
      </div>
    </div>
    <button class="add-btn" onclick="openPurchaseModal()">+ Add Purchase</button>
  </div>

  <div class="purchases-table">
  <table id="purchasesTable">
    <thead>
      <tr>
        <th>Invoice Number</th>
        <th>Date Received</th>
        <th>Supplier</th>
        <th>Product Name</th>
        <th>Dosage</th>
        <th>Batch Number</th>
        <th>Quantity</th>
        <th>Qty/Box</th>
        <th>Unit</th>
        <th>Expiry Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if purchases %}
        {% for purchase in purchases %}
          <tr data-purchase-id="{{ purchase[0] }}" data-product-id="{{ purchase[1] }}" data-quantity-per-box="{{ purchase[12] if purchase[12] else '1' }}">
            <td>{{ purchase[11] if purchase[11] else 'N/A' }}</td>
            <td>{{ purchase[9] }}</td>
            <td>{{ purchase[10] }}</td>
            <td>{{ purchase[1] }}</td>
            <td>{{ purchase[2] if purchase[2] else '' }}</td>
            <td>{{ purchase[3] }}</td>
            <td>{{ purchase[4] }}</td>
            <td>{{ purchase[12] if purchase[12] else '1' }}</td>
            <td>{{ purchase[5] if purchase[5] else 'N/A' }}</td>
            <td>{{ purchase[7] }}</td>
            <td>{{ purchase[8] }}</td>
            <td>
              <button onclick="editPurchase('{{ purchase[0] }}')">Edit</button>
              <button onclick="deletePurchase('{{ purchase[0] }}')">Delete</button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="12" style="text-align:center;">No purchases found</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
  
</main>

<!-- Product Datalist (for the purchase modal) -->
<datalist id="productsList">
  {% for prod in products %}
    <option value="{{ prod[1] }}{% if prod[2] %} - {{ prod[2] }}{% endif %} ({{ prod[3] if prod[3] else 'N/A' }})" 
            data-id="{{ prod[0] }}" 
            data-dosage="{{ prod[2] if prod[2] else '' }}" 
            data-unit="{{ prod[3] if prod[3] else '' }}">
  {% endfor %}
</datalist>

<!-- Updated purchase modal with batch number and improved styling -->
<div id="purchaseModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:400px; position:relative; font-size:13px;">
    <h2 id="modalTitle" style="font-size:18px; margin-bottom:15px;">Add Purchase</h2>
    <form id="purchaseForm" action="/add-purchase" method="POST">
      <!-- Hidden field to store product_id -->
      <input type="hidden" name="product_id" id="productIdInput">
      
      <label>Invoice Number:</label><br>
      <input type="text" name="invoice_number" placeholder="Enter invoice number" style="width:100%; padding:6px; margin-bottom:10px; font-size:13px;"><br>
      
      <label>Product:</label><br>
      <input type="text" id="productSearch" 
             list="productsList" 
             placeholder="Type to search products..." 
             autocomplete="off"
             required 
             oninput="updatePurchaseProductInfo()"
             style="width:100%; padding:6px; margin-bottom:10px; font-size:13px;">
      <br>
      
      <!-- New Batch Number field -->
      <label>Batch Number:</label><br>
      <input type="text" name="batch_number" id="batchNumberInput" placeholder="Enter batch number" required style="width:100%; padding:6px; margin-bottom:10px; font-size:13px;"><br>
      
      <label>Purchase Quantity:</label><br>
      <input type="number" name="purchase_quantity" min="1" required style="width:100%; padding:6px; margin-bottom:10px; font-size:13px;"><br>

      <label>Quantity per Box (pieces per box):</label><br>
      <input type="number" name="quantity_per_box" id="quantityPerBox" min="1" value="1" required style="width:100%; padding:6px; margin-bottom:10px; font-size:13px;"><br>
      
      <label>Expiration Date:</label><br>
      <input type="date" name="expiration_date" required style="width:100%; padding:6px; margin-bottom:10px; font-size:13px;"><br>
      
      <label>Supplier:</label><br>
      <select name="supplier" id="supplierSelect" onchange="toggleOtherSupplier()" required style="width:100%; padding:6px; margin-bottom:10px; font-size:13px;">
        <option value="">Select Supplier</option>
        {% for supplier in suppliers %}
          <option value="{{ supplier }}">{{ supplier }}</option>
        {% endfor %}
        <option value="__other__">Other (enter below)</option>
      </select>
      <div id="otherSupplierGroup" style="display:none; margin-bottom:10px;">
        <input type="text" id="otherSupplierInput" placeholder="Enter supplier name" style="width:100%; padding:6px; font-size:13px;">
      </div>

      <div style="text-align:right; margin-top:15px;">
        <button type="button" onclick="closePurchaseModal()" style="padding:6px 12px; font-size:13px;">Cancel</button>
        <button type="submit" id="modalSubmit" style="padding:6px 12px; font-size:13px;">Add</button>
      </div>
    </form>
  </div>
</div>
  
<style>
  /* Improved table styling */
  .purchases-table {
    font-family: Arial, sans-serif;
  }
  
  .purchases-table table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 13px; /* Smaller font for table */
  }
  
  .purchases-table th {
    background-color: #f5f5f5;
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    border-bottom: 2px solid #ddd;
  }
  
  .purchases-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #eee;
    line-height: 1.4;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .purchases-table tr:hover td {
    background-color: #f9f9f9;
  }
  
  .purchases-table tr.expanded td {
    white-space: normal;
    overflow: visible;
    max-width: none;
    background-color: #f0f8ff;
  }
  
  td button {
    margin: 2px;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px; /* Smaller font for buttons */
  }
  td button:first-child {
    background-color: #4CAF50;
    color: white;
  }
  td button:last-child {
    background-color: #f44336;
    color: white;
  }
  
  /* Form styling */
  .modal input, .modal select, .modal label, .modal button {
    font-size: 13px !important;
  }
  
  /* Style for datalist dropdown */
  datalist {
    max-height: 200px;
    overflow-y: auto;
  }
  
  /* Highlight for invalid product selection */
  .product-invalid {
    border-color: #ff4444 !important;
    border-width: 2px !important;
  }
  
  /* Make sure inputs have consistent styling */
  input, select {
    box-sizing: border-box;
  }
</style>

<script>
// Create a map to store product data for quick lookup
let productDataMap = {};

// Initialize the product data map when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Get all options from the datalist
  const datalist = document.getElementById('productsList');
  const options = datalist ? datalist.querySelectorAll('option') : [];
  
  // Populate the product data map
  options.forEach(option => {
    productDataMap[option.value] = {
      id: option.getAttribute('data-id'),
      dosage: option.getAttribute('data-dosage'),
      unit: option.getAttribute('data-unit')
    };
  });
  
  console.log('Product data map loaded:', productDataMap);
  
  const table = document.getElementById('purchasesTable');
  const cells = table.getElementsByTagName('td');
  
  for (let cell of cells) {
    cell.addEventListener('click', function() {
      const allCells = table.getElementsByTagName('td');
      for (let c of allCells) {
        c.classList.remove('expanded');
      }
      
      this.classList.toggle('expanded');
    });
  }
});

let isSubmitting = false;

document.getElementById("purchaseForm").addEventListener("submit", function(e) {
  e.preventDefault();
  
  // Prevent double submission
  if (isSubmitting) {
    alert('Please wait, form is already submitting...');
    return;
  }
  
  // Validate product selection
  const productSearch = document.getElementById('productSearch');
  const productIdInput = document.getElementById('productIdInput');
  
  if (!productIdInput.value) {
    alert('Please select a valid product from the list.');
    productSearch.classList.add('product-invalid');
    return;
  }
  
  // Validate batch number
  const batchNumberInput = document.getElementById('batchNumberInput');
  if (!batchNumberInput.value.trim()) {
    alert('Please enter a batch number.');
    batchNumberInput.focus();
    return;
  }
  
  isSubmitting = true;
  const form = this;
  const submitButton = form.querySelector('button[type="submit"]');
  const originalButtonText = submitButton.textContent;
  
  // Show loading state
  submitButton.textContent = 'Processing...';
  submitButton.disabled = true;
  
  // Handle "Other" supplier option
  const formData = new FormData(form);
  if (form.supplier.value === '__other__') {
    const otherSupplier = document.getElementById('otherSupplierInput').value;
    if (otherSupplier.trim() === '') {
      alert('Please enter a supplier name');
      submitButton.textContent = originalButtonText;
      submitButton.disabled = false;
      isSubmitting = false;
      return;
    }
    formData.set('supplier', otherSupplier);
  }
  
  fetch(form.action, {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if (data.success) {
      location.reload();
    } else {
      submitButton.textContent = originalButtonText;
      submitButton.disabled = false;
      isSubmitting = false;
    }
  })
  .catch(err => {
    alert('Error: ' + err);
    submitButton.textContent = originalButtonText;
    submitButton.disabled = false;
    isSubmitting = false;
  });
});

// Fixed product search function - doesn't auto-pick
function updatePurchaseProductInfo() {
  const productSearch = document.getElementById('productSearch');
  const productIdInput = document.getElementById('productIdInput');
  const searchValue = productSearch.value.trim();
  
  // Clear previous product ID
  productIdInput.value = '';
  
  // Remove invalid class if present
  productSearch.classList.remove('product-invalid');
  
  if (!searchValue) {
    return;
  }
  
  // Check if the product exists in our map (exact match only when selected from dropdown)
  // We'll let the user select from dropdown without auto-picking
  if (productDataMap[searchValue]) {
    // Exact match found (user selected from dropdown)
    productIdInput.value = productDataMap[searchValue].id;
    productSearch.classList.remove('product-invalid');
  } else {
    // Mark as invalid only if there's text but no match
    // Don't auto-pick anything
    if (searchValue.length > 0) {
      productSearch.classList.add('product-invalid');
    }
  }
}

// Improved function to handle dropdown selection properly
function handleProductSearchInput() {
  const productSearch = document.getElementById('productSearch');
  
  // Listen for the 'input' event
  productSearch.addEventListener('input', function(e) {
    // Only validate when user stops typing for a moment
    clearTimeout(this.timer);
    this.timer = setTimeout(() => {
      updatePurchaseProductInfo();
    }, 500);
  });
  
  // Listen for the 'change' event (when user selects from dropdown)
  productSearch.addEventListener('change', function(e) {
    updatePurchaseProductInfo();
  });
}

// Call this when page loads
document.addEventListener('DOMContentLoaded', function() {
  handleProductSearchInput();
});

function searchPurchasesTable() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#purchasesTable tbody tr");

  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(input) ? "" : "none";
  });
}

function togglePurchaseFilters() {
  const filterOptions = document.getElementById("purchaseFilterOptions");
  filterOptions.style.display = filterOptions.style.display === "none" ? "block" : "none";
}

function applyPurchaseFilters() {
  const batchVal = document.getElementById("batchFilter").value.toLowerCase();
  const statusVal = document.getElementById("statusFilter").value.toLowerCase();
  const dateVal = document.getElementById("dateFilter").value;
  const rows = document.querySelectorAll("#purchasesTable tbody tr");

  rows.forEach(row => {
    const batch = row.cells[5].textContent.toLowerCase();
    const status = row.cells[10].textContent.toLowerCase();
    const date = row.cells[1].textContent;

    const matchBatch = !batchVal || batch.includes(batchVal);
    const matchStatus = !statusVal || status === statusVal;
    const matchDate = !dateVal || date === dateVal;

    row.style.display = matchBatch && matchStatus && matchDate ? "" : "none";
  });
}
  
function openPurchaseModal() {
  document.getElementById("purchaseModal").style.display = "block";
  
  // Reset form if it's for adding new purchase
  const form = document.getElementById("purchaseForm");
  if (form.action.endsWith('/add-purchase')) {
    form.reset();
    document.getElementById("modalTitle").textContent = "Add Purchase";
    document.getElementById("modalSubmit").textContent = "Add";
    document.getElementById('productIdInput').value = '';
    document.getElementById('productSearch').value = '';
    document.getElementById('productSearch').classList.remove('product-invalid');
    document.getElementById('batchNumberInput').value = '';
    document.getElementById('quantityPerBox').value = '1';
  }
}

function closePurchaseModal() {
  document.getElementById("purchaseModal").style.display = "none";
  // Reset form when closing modal
  const form = document.getElementById("purchaseForm");
  form.reset();
  document.getElementById('productIdInput').value = '';
  document.getElementById('productSearch').value = '';
  document.getElementById('productSearch').classList.remove('product-invalid');
  document.getElementById('batchNumberInput').value = '';
  document.getElementById('quantityPerBox').value = '1';
  // Reset form action to add-purchase for next time
  form.action = '/add-purchase';
}
  
function editPurchase(id) {
  const row = document.querySelector(`#purchasesTable tbody tr[data-purchase-id='${id}']`);

  const invoiceNumber = row.cells[0].textContent.trim();
  const dateReceived = row.cells[1].textContent;
  const supplier = row.cells[2].textContent;
  const productText = row.cells[3].textContent;
  const dosage = row.cells[4].textContent;
  const batchNumber = row.cells[5].textContent;
  const quantity = row.cells[6].textContent;
  const qtyPerBox = row.cells[7].textContent;
  const unit = row.cells[8].textContent;
  const expiry = row.cells[9].textContent;
  const status = row.cells[10].textContent;
  const quantityPerBox = row.getAttribute('data-quantity-per-box') || '1';

  const form = document.getElementById("purchaseForm");
  form.action = '/edit-purchase/' + id;

  document.getElementById("modalTitle").textContent = "Edit Purchase";
  document.getElementById("modalSubmit").textContent = "Update";

  // Populate form fields
  form.invoice_number.value = invoiceNumber === 'N/A' ? '' : invoiceNumber;
  
  // Set product search field
  document.getElementById('productSearch').value = productText;
  document.getElementById('quantityPerBox').value = quantityPerBox;
  document.getElementById('batchNumberInput').value = batchNumber;
  
  // Find the product ID from the data map
  const productSearchValue = productText;
  let productId = '';
  
  // Try to find exact match first
  if (productDataMap[productSearchValue]) {
    productId = productDataMap[productSearchValue].id;
  } else {
    // Try to find a matching product by constructing the full name
    for (const [key, value] of Object.entries(productDataMap)) {
      if (key.includes(productText)) {
        productId = value.id;
        // Update the display to show full product name
        document.getElementById('productSearch').value = key;
        break;
      }
    }
  }
  
  document.getElementById('productIdInput').value = productId;
  
  form.purchase_quantity.value = quantity;
  form.expiration_date.value = expiry;
  
  // Set supplier dropdown
  const supplierSelect = form.supplier;
  // Try to find the supplier in the options
  let found = false;
  for (let option of supplierSelect.options) {
    if (option.textContent === supplier) {
      supplierSelect.value = option.value;
      found = true;
      break;
    }
  }
  // If supplier not found, select the first option (empty)
  if (!found) {
    supplierSelect.selectedIndex = 0;
  }

  openPurchaseModal();
}

function deletePurchase(id) {
  if (confirm("Are you sure you want to delete this purchase?")) {
    fetch('/delete-purchase/' + id, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      if (data.success) location.reload();
    })
    .catch(err => alert('Error deleting purchase: ' + err));
  }
}

function toggleOtherSupplier() {
  const supplierSelect = document.getElementById('supplierSelect');
  const otherGroup = document.getElementById('otherSupplierGroup');
  
  if (supplierSelect.value === '__other__') {
    otherGroup.style.display = 'block';
  } else {
    otherGroup.style.display = 'none';
  }
}

// Add keyboard navigation for product search
document.addEventListener('DOMContentLoaded', function() {
  const productSearch = document.getElementById('productSearch');
  if (productSearch) {
    // Don't auto-submit on Enter in the product field
    productSearch.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        updatePurchaseProductInfo();
      }
    });
  }
});
    
    // Also update when user selects from dropdown
    productSearch.addEventListener('change', updatePurchaseProductInfo);
  }
});

  let currentSort = {
    column: 'id',
    direction: 'asc'
  };

  function sortTable() {
    const table = document.getElementById('purchasesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
      let aValue = a.children[getColumnIndex(currentSort.column)].textContent;
      let bValue = b.children[getColumnIndex(currentSort.column)].textContent;
      
      if (currentSort.column === 'id' || currentSort.column === 'quantity' || currentSort.column === 'remaining') {
        aValue = parseFloat(aValue.replace(/[^0-9.-]+/g, ''));
        bValue = parseFloat(bValue.replace(/[^0-9.-]+/g, ''));
      }
      
      if (currentSort.column === 'date' || currentSort.column === 'expiration') {
        aValue = new Date(aValue);
        bValue = new Date(bValue);
      }
      
      if (currentSort.direction === 'asc') {
        return aValue > bValue ? 1 : -1;
      } else {
        return aValue < bValue ? 1 : -1;
      }
    });
    
    rows.forEach(row => tbody.appendChild(row));
  }

  sortTable();

  document.querySelectorAll('.sort-btn').forEach(button => {
    button.addEventListener('click', () => {
      const column = button.dataset.sort;
      
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      
      sortTable();
    });
  });

  function getColumnIndex(column) {
    const columnMap = {
      'id': 0,
      'name': 1,
      'batch': 2,
      'quantity': 3,
      'remaining': 4,
      'expiration': 5,
      'status': 6,
      'date': 7,
      'supplier': 8
    };
    return columnMap[column];
  }
</script>

{% endblock %}





